<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryCanvas - Tablero Digital para Autoras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            overscroll-behavior: none;
            font-family: sans-serif;
        }
        .canvas-container {
            width: 100%;
            height: calc(100vh - 70px);
            position: relative;
            overflow: hidden;
            background-color: #f8fafc;
            background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 8px;
        }
        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: top left;
            transition: transform 0.2s ease-out;
            z-index: 1;
        }
        #connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: visible;
        }
        #connection-svg line {
            stroke: #94a3b8;
            stroke-width: 2;
            cursor: pointer;
            pointer-events: stroke;
            transition: stroke 0.2s, stroke-width 0.2s;
        }
         #connection-svg line:hover {
             stroke: #ef4444;
             stroke-width: 4;
         }

        /* --- Estilos de Tarjeta --- */
        .card {
            position: absolute;
            min-width: 150px;
            min-height: 150px; /* Aumentada altura mínima para acomodar textarea en imagen */
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: move;
            transition: box-shadow 0.2s, transform 0.1s;
            overflow: visible;
            display: flex;
            flex-direction: column;
            z-index: 10;
            border: 1px solid #e5e7eb;
            width: 250px;
            height: 280px; /* Aumentada altura por defecto para imagen + texto */
        }
        .card.dragging { z-index: 1000; cursor: grabbing; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card.resizing { z-index: 1000; cursor: nwse-resize; user-select: none; }
        .card-header { padding: 6px 10px; border-bottom: 1px solid #e5e7eb; font-weight: 600; background-color: rgba(249, 250, 251, 0.8); display: flex; justify-content: space-between; align-items: center; cursor: grab; border-radius: 8px 8px 0 0; }
        .card:active .card-header { cursor: grabbing; }
        .card-header-title { flex-grow: 1; margin-right: 8px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; outline: none; }
        .card-header-title:focus { white-space: normal; text-overflow: clip; }
        .card-header-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .card-control-btn { cursor: pointer; color: #6b7280; font-size: 13px; padding: 3px; line-height: 1; transition: color 0.2s; }
        .card-control-btn:hover { color: #1f2937; }
        .card-delete-btn:hover { color: #ef4444; }
        .card-connect-btn:hover { color: #3b82f6; }
        .card-color-btn:hover { opacity: 0.8; }

        .card-body {
            padding: 10px 12px; /* Restaurar padding por defecto */
            font-size: 13px;
            line-height: 1.4;
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        /* Layout específico para el body de la tarjeta de imagen */
        .card[data-card-type="image"] .card-body {
             padding: 0; /* Quitar padding general del body para imagen */
             /* El padding se manejará en los elementos internos */
        }

        /* Textarea general (para tipos texto) */
        .card:not([data-card-type="image"]) .card-body textarea {
            width: 100%;
            border: none;
            padding: 0;
            font-size: 13px;
            line-height: inherit;
            flex-grow: 1;
            resize: none;
            background-color: transparent;
            min-height: 40px;
            outline: none;
            overflow-y: auto;
        }

        /* --- Estilos específicos para Tarjeta de Imagen --- */
        .image-url-input {
            width: 100%;
            border: none;
            border-bottom: 1px solid #e5e7eb; /* Borde inferior */
            padding: 8px 12px; /* Padding interno */
            font-size: 12px;
            outline: none;
            box-sizing: border-box;
            flex-shrink: 0;
            background-color: #f9fafc;
        }
        .image-url-input:focus {
            border-bottom: 1px solid #3b82f6;
        }
        .image-display-container {
            flex-grow: 1; /* Ocupar espacio vertical restante */
            position: relative;
            background-color: #e5e7eb;
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            overflow: hidden;
            /* Sin border-radius aquí si hay textarea debajo */
            min-height: 100px; /* Altura mínima para el display */
            display: flex;
            align-items: center;
            justify-content: center;
        }
         .image-display-container::before { /* Icono placeholder */
            content: '\f03e';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900; font-size: 30px;
            color: #9ca3af; opacity: 0.5;
         }
         .image-display-container[style*="background-image: url"]::before { display: none; }

         /* Textarea específico para tarjeta de imagen */
         .card[data-card-type="image"] .card-body textarea {
             width: 100%;
             border: none;
             border-top: 1px solid #e5e7eb; /* Separador superior */
             padding: 8px 12px; /* Padding interno */
             font-size: 13px;
             line-height: 1.4;
             flex-shrink: 0; /* No encoger */
             resize: none;
             background-color: #ffffff; /* Fondo blanco para distinguir */
             min-height: 60px; /* Altura mínima */
             max-height: 120px; /* Altura máxima antes de scroll */
             outline: none;
             overflow-y: auto; /* Scroll si excede max-height */
             box-sizing: border-box;
         }


        .card-footer { padding: 5px 10px; font-size: 11px; color: #6b7280; border-top: 1px solid #e5e7eb; flex-shrink: 0; border-radius: 0 0 8px 8px; background-color: #f9fafc; }
        .resize-handle { position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; background-color: rgba(150, 150, 150, 0.6); border: 1px solid rgba(255, 255, 255, 0.9); border-radius: 0 0 8px 0; cursor: nwse-resize; z-index: 11; transition: background-color 0.2s; }
        .resize-handle:hover { background-color: rgba(100, 100, 100, 0.8); }
        .color-picker-wrapper { position: relative; display: inline-block; }
        .card-color-btn { width: 18px; height: 18px; border-radius: 50%; border: 1px solid #d1d5db; cursor: pointer; display: inline-block; vertical-align: middle; transition: transform 0.1s; }
        .card-color-btn:hover { transform: scale(1.1); }
        .native-color-picker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 12; }
        body.connecting-mode { cursor: crosshair; }
        .card.connection-candidate { outline: 2px dashed #60a5fa; outline-offset: 3px; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
        .card.is-connection-source { outline: 2px solid #3b82f6; outline-offset: 3px; }
        .zoom-controls { position: absolute; bottom: 16px; right: 16px; z-index: 50; background: white; border-radius: 8px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); display: flex; flex-direction: column; overflow: hidden; }
        .zoom-btn { padding: 10px 14px; border: none; background: none; cursor: pointer; font-size: 16px; color: #374151; transition: background-color 0.2s; }
        .zoom-btn:hover { background-color: #f3f4f6; }
        .zoom-btn:first-child { border-bottom: 1px solid #e5e7eb; }
        .zoom-btn:active { background-color: #e5e7eb; }
        .canvas-scale { position: absolute; bottom: 16px; left: 16px; background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; color: #374151; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); z-index: 50; }
        .hidden-file-input { display: none; }
        #save-indicator { transition: background-color 0.3s, opacity 0.3s; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-md flex-shrink-0 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-feather-alt text-2xl"></i>
                <h1 class="text-xl font-semibold">StoryCanvas</h1>
            </div>
            <div class="flex items-center space-x-3">
                 <button id="save-indicator" class="px-3 py-1.5 text-sm bg-indigo-600 rounded-md flex items-center opacity-50 cursor-not-allowed">
                    <i class="fas fa-check mr-1.5 text-xs"></i> Guardado
                </button>
                 <button id="import-btn" title="Importar desde archivo JSON" class="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-500 rounded-md flex items-center transition-colors">
                    <i class="fas fa-file-import mr-1.5"></i> Importar
                </button>
                <button id="export-btn" title="Exportar lienzo a archivo JSON" class="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-500 rounded-md flex items-center transition-colors">
                    <i class="fas fa-file-export mr-1.5"></i> Exportar
                </button>
                <input type="file" id="import-file-input" class="hidden-file-input" accept=".json,application/json">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden p-4">
        <!-- Sidebar -->
        <aside class="w-60 bg-white rounded-lg shadow p-4 mr-4 flex-shrink-0 flex flex-col self-start sticky top-[60px]">
             <div>
                <!-- <h2 class="text-base font-semibold mb-4 text-gray-700">Herramientas</h2> -->
                <div class="mb-5">
                    <h3 class="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wider">Añadir Tarjeta al proyecto</h3>
                    <button id="add-chapter-btn" data-type="chapter" class="add-card-btn w-full p-2 text-sm bg-purple-50 hover:bg-purple-100 rounded-md text-purple-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-book-open mr-2 w-4 text-center"></i> Capítulo
                    </button>
                    <button id="add-scene-btn" data-type="scene" class="add-card-btn w-full p-2 text-sm bg-blue-50 hover:bg-blue-100 rounded-md text-blue-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-film mr-2 w-4 text-center"></i> Escena
                    </button>
                    <button id="add-idea-btn" data-type="idea" class="add-card-btn w-full p-2 text-sm bg-green-50 hover:bg-green-100 rounded-md text-green-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-lightbulb mr-2 w-4 text-center"></i> Idea
                    </button>
                    <button id="add-image-btn" data-type="image" class="add-card-btn w-full p-2 text-sm bg-orange-50 hover:bg-orange-100 rounded-md text-orange-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-image mr-2 w-4 text-center"></i> Imagen
                    </button>
                </div>
             </div>
             <div class="mt-auto border-t pt-4">
                 <button id="clear-storage-btn" title="Borrar todo el contenido del lienzo" class="w-full p-2 text-sm bg-red-50 hover:bg-red-100 text-red-700 rounded-md flex items-center justify-center transition-colors">
                     <i class="fas fa-trash-alt mr-2"></i> Limpiar Todo
                 </button>
             </div>
        </aside>

        <!-- Canvas Area -->
        <main class="flex-1 relative">
            <div id="free-view" class="canvas-container">
                <div id="canvas-content-free" class="canvas-content">
                     <svg id="connection-svg"></svg>
                </div>
                <div class="zoom-controls">
                    <button id="zoom-in" title="Acercar" class="zoom-btn"><i class="fas fa-search-plus"></i></button>
                    <button id="zoom-out" title="Alejar" class="zoom-btn"><i class="fas fa-search-minus"></i></button>
                </div>
                <div id="canvas-scale-label" class="canvas-scale">100%</div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const STORAGE_KEY = 'storyCanvasData_v5'; // Incrementar versión

    // --- Referencias a elementos del DOM ---
    const canvasContainer = document.getElementById('free-view');
    const canvasContent = document.getElementById('canvas-content-free');
    const connectionSvg = document.getElementById('connection-svg');
    const addCardButtons = document.querySelectorAll('.add-card-btn');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const scaleLabel = document.getElementById('canvas-scale-label');
    const clearStorageBtn = document.getElementById('clear-storage-btn');
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importFileInput = document.getElementById('import-file-input');
    const saveIndicator = document.getElementById('save-indicator');

    // --- Estado de la aplicación ---
    let cards = [];
    let connections = [];
    let activeCard = null;
    let resizingCard = null;
    let connectingCardId = null;
    let startX, startY, initialWidth, initialHeight;
    let dragOffsetX, dragOffsetY;
    let currentScale = 1.0;
    let isDragging = false;
    let isResizing = false;
    let saveTimeout = null;

    const typeTranslations = { scene: "Escena", chapter: "Capítulo", idea: "Idea", image: "Imagen" };
    const MIN_CARD_WIDTH = 150;
    const MIN_CARD_HEIGHT = 150; // Aumentado
    const MAX_ZOOM = 3.0;
    const MIN_ZOOM = 0.2;

    function getSpanishTypeName(type) { return typeTranslations[type] || type; }

    // --- Funciones de Guardado y Carga ---
    function showSaveIndicator(saving = false) {
        if (!saveIndicator) return;
        if (saving) {
            saveIndicator.innerHTML = '<i class="fas fa-save mr-1.5 text-xs animate-spin"></i> Guardando...';
            saveIndicator.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-indigo-600');
            saveIndicator.classList.add('bg-yellow-500');
        } else {
            saveIndicator.innerHTML = '<i class="fas fa-check mr-1.5 text-xs"></i> Guardado';
            saveIndicator.classList.add('opacity-50', 'cursor-not-allowed', 'bg-indigo-600');
            saveIndicator.classList.remove('bg-yellow-500');
        }
    }

    function saveData() {
        clearTimeout(saveTimeout);
        showSaveIndicator(true);
        saveTimeout = setTimeout(() => {
            try {
                const dataToSave = {
                    cards: cards,
                    connections: connections,
                    scale: currentScale,
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('Datos guardados:', new Date().toLocaleTimeString());
                showSaveIndicator(false);
            } catch (error) {
                console.error("Error al guardar en localStorage:", error);
                alert("Error al guardar los datos. Es posible que el almacenamiento local esté lleno.");
                showSaveIndicator(false);
            }
        }, 700);
    }

    function loadData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const parsedData = JSON.parse(savedData);
                cards = parsedData.cards || [];
                connections = parsedData.connections || [];
                currentScale = parsedData.scale || 1.0;

                // Validar y aplicar valores por defecto
                cards.forEach(card => {
                    card.width = card.width >= MIN_CARD_WIDTH ? card.width : (card.type === 'image' ? 250 : MIN_CARD_WIDTH);
                    card.height = card.height >= MIN_CARD_HEIGHT ? card.height : (card.type === 'image' ? 280 : MIN_CARD_HEIGHT); // Usar nuevo default
                    card.color = card.color || getRandomColor();
                    card.title = card.title || `Sin título`;
                    card.type = card.type || 'idea';
                    card.x = typeof card.x === 'number' ? card.x : 50;
                    card.y = typeof card.y === 'number' ? card.y : 50;
                    // Ahora AMBOS pueden existir (inicializar si faltan)
                    card.content = card.content || '';
                    card.imageUrl = card.imageUrl || '';
                    // Asegurarse de que imageUrl sea undefined si no es tipo imagen (limpieza de datos antiguos)
                    if (card.type !== 'image' && card.imageUrl !== undefined) {
                        delete card.imageUrl;
                    }
                });
                connections = connections.filter(conn => conn.id && conn.fromId && conn.toId);
                console.log('Datos cargados desde localStorage.');
            } catch (error) {
                console.error("Error al parsear datos de localStorage:", error);
                alert("Error al cargar los datos guardados. Empezando con un lienzo vacío.");
                resetState();
            }
        } else {
            console.log('No se encontraron datos guardados. Inicializando lienzo vacío.');
            resetState();
        }
        renderAllCards();
        applyZoom();
    }

    function resetState() {
        cards = [];
        connections = [];
        currentScale = 1.0;
     }

    // --- Funciones de Renderizado ---

    function renderCard(cardData) {
        if (!canvasContent) return;

        const cardElement = document.createElement('div');
        cardElement.className = 'card';
        cardElement.dataset.id = cardData.id;
        cardElement.dataset.cardType = cardData.type;
        cardElement.style.left = `${cardData.x}px`;
        cardElement.style.top = `${cardData.y}px`;
        cardElement.style.width = `${cardData.width}px`;
        cardElement.style.height = `${cardData.height}px`;
        cardElement.style.backgroundColor = cardData.color;

        // --- Header (Común) ---
        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header';
        const titleSpan = document.createElement('span');
        titleSpan.className = 'card-header-title';
        titleSpan.textContent = cardData.title;
        titleSpan.contentEditable = true;
        titleSpan.spellcheck = false;
        titleSpan.addEventListener('blur', (e) => { if (e.target instanceof HTMLElement) updateCardData(cardData.id, { title: e.target.textContent || 'Sin título' }); });
        titleSpan.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); if (e.target instanceof HTMLElement) e.target.blur(); } });
        titleSpan.addEventListener('mousedown', (e) => e.stopPropagation());

        const headerControls = document.createElement('div');
        headerControls.className = 'card-header-controls';
        // --- Controles del Header ---
        // Color Picker
        const colorPickerWrapper = document.createElement('div');
        colorPickerWrapper.className = 'color-picker-wrapper';
        const colorBtn = document.createElement('span');
        colorBtn.className = 'card-color-btn card-control-btn';
        colorBtn.style.backgroundColor = cardData.color;
        colorBtn.title = 'Cambiar color';
        const nativeColorPicker = document.createElement('input');
        nativeColorPicker.type = 'color';
        nativeColorPicker.className = 'native-color-picker';
        nativeColorPicker.value = cardData.color;
        nativeColorPicker.addEventListener('input', (e) => { if (e.target instanceof HTMLInputElement) { cardElement.style.backgroundColor = e.target.value; colorBtn.style.backgroundColor = e.target.value; } });
        nativeColorPicker.addEventListener('change', (e) => { if (e.target instanceof HTMLInputElement) updateCardData(cardData.id, { color: e.target.value }); });
        nativeColorPicker.addEventListener('mousedown', (e) => e.stopPropagation());
        colorPickerWrapper.appendChild(colorBtn); colorPickerWrapper.appendChild(nativeColorPicker); headerControls.appendChild(colorPickerWrapper);
        // Botón Conectar
        const connectBtn = document.createElement('i');
        connectBtn.className = 'fas fa-link card-connect-btn card-control-btn';
        connectBtn.title = 'Crear conexión';
        connectBtn.addEventListener('click', (e) => { e.stopPropagation(); startConnectionMode(cardData.id); });
        headerControls.appendChild(connectBtn);
        // Botón Eliminar
        const deleteBtn = document.createElement('i');
        deleteBtn.className = 'fas fa-trash-alt card-delete-btn card-control-btn';
        deleteBtn.title = 'Eliminar tarjeta';
        deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`¿Eliminar tarjeta "${cardData.title}"?`)) deleteCard(cardData.id); });
        headerControls.appendChild(deleteBtn);

        cardHeader.appendChild(titleSpan);
        cardHeader.appendChild(headerControls);

        // --- Body (Depende del tipo) ---
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        // Crear Textarea (común a todos ahora)
        const contentTextarea = document.createElement('textarea');
        contentTextarea.placeholder = 'Escribe notas aquí...';
        contentTextarea.value = cardData.content || ''; // Usar valor de content
        contentTextarea.addEventListener('change', (e) => { if (e.target instanceof HTMLTextAreaElement) updateCardData(cardData.id, { content: e.target.value }); });
        contentTextarea.addEventListener('mousedown', (e) => e.stopPropagation());

        if (cardData.type === 'image') {
            // --- Contenido específico para Tarjeta de Imagen (URL y Display) ---
            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.className = 'image-url-input';
            urlInput.placeholder = 'Pega la URL de la imagen aquí...';
            urlInput.value = cardData.imageUrl || '';
            urlInput.spellcheck = false;
            urlInput.addEventListener('mousedown', (e) => e.stopPropagation());

            const imageDisplay = document.createElement('div');
            imageDisplay.className = 'image-display-container';
            if (cardData.imageUrl) setImageBackground(imageDisplay, cardData.imageUrl);

            urlInput.addEventListener('change', (e) => {
                 if (!(e.target instanceof HTMLInputElement)) return;
                 const newUrl = e.target.value.trim();
                 updateCardData(cardData.id, { imageUrl: newUrl }); // Actualizar imageUrl
                 setImageBackground(imageDisplay, newUrl);
            });

            // Añadir en orden: Input URL, Imagen, Textarea
            cardBody.appendChild(urlInput);
            cardBody.appendChild(imageDisplay);
            cardBody.appendChild(contentTextarea); // Añadir el textarea al final

        } else {
            // --- Contenido para Tarjetas de Texto (Solo el Textarea) ---
             cardBody.appendChild(contentTextarea);
        }

        // --- Footer (Común) ---
        const cardFooter = document.createElement('div');
        cardFooter.className = 'card-footer';
        const typeSpan = document.createElement('span');
        typeSpan.textContent = getSpanishTypeName(cardData.type);
        cardFooter.appendChild(typeSpan);

        // --- Handle de Redimensionamiento (Común) ---
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        resizeHandle.addEventListener('mousedown', startResize);

        // --- Ensamblaje y Eventos Globales ---
        cardElement.appendChild(cardHeader);
        cardElement.appendChild(cardBody);
        cardElement.appendChild(cardFooter);
        cardElement.appendChild(resizeHandle);
        cardElement.addEventListener('click', handleCardClickForConnection);
        cardElement.addEventListener('mousedown', startDrag);
        canvasContent.appendChild(cardElement);
    }

    // Función auxiliar para establecer la imagen de fondo y manejar errores
    function setImageBackground(element, url) {
        if (!url) {
            element.style.backgroundImage = '';
            return;
        }
        const imgTest = new Image();
        imgTest.onload = () => {
            element.style.backgroundImage = `url('${url}')`;
            console.log(`Imagen cargada: ${url}`);
        };
        imgTest.onerror = () => {
            element.style.backgroundImage = '';
            console.warn(`Error al cargar imagen: ${url}`);
        };
        imgTest.src = url;
    }


    // Limpia y renderiza todas las tarjetas y líneas
    function renderAllCards() {
        if (!canvasContent || !connectionSvg) return;
        canvasContent.querySelectorAll('.card').forEach(node => node.remove());
        connectionSvg.innerHTML = '';
        cards.forEach(card => renderCard(card));
        renderAllLines();
    }

    // --- Funciones de Líneas de Conexión ---
    function renderLine(connection) {
        if (!canvasContent || !connectionSvg) return;
        const fromCardEl = canvasContent.querySelector(`.card[data-id="${connection.fromId}"]`);
        const toCardEl = canvasContent.querySelector(`.card[data-id="${connection.toId}"]`);
        if (!fromCardEl || !toCardEl) return;
        const x1 = fromCardEl.offsetLeft + fromCardEl.offsetWidth / 2;
        const y1 = fromCardEl.offsetTop + fromCardEl.offsetHeight / 2;
        const x2 = toCardEl.offsetLeft + toCardEl.offsetWidth / 2;
        const y2 = toCardEl.offsetTop + toCardEl.offsetHeight / 2;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1); line.setAttribute('y1', y1);
        line.setAttribute('x2', x2); line.setAttribute('y2', y2);
        line.dataset.connectionId = connection.id;
        line.addEventListener('click', (e) => { e.stopPropagation(); if (confirm('¿Eliminar conexión?')) deleteConnection(connection.id); });
        connectionSvg.appendChild(line);
    }
    function renderAllLines() { if (!connectionSvg) return; connectionSvg.innerHTML = ''; connections.forEach(renderLine); }
    function updateLinesForCard(cardId) {
        if (!connectionSvg) return;
        connections.forEach(conn => {
            if (conn.fromId === cardId || conn.toId === cardId) {
                const lineElement = connectionSvg.querySelector(`line[data-connection-id="${conn.id}"]`);
                if (lineElement) lineElement.remove();
                renderLine(conn);
            }
        });
    }

    // --- Funciones de Manipulación de Tarjetas ---
    function addCard(type) {
        const containerRect = canvasContainer?.getBoundingClientRect();
        let initialX = 50, initialY = 50;
        let initialWidth = 250, initialHeight = (type === 'image' ? 280 : 180);
        if(containerRect){
             initialX = (canvasContainer.scrollLeft + containerRect.width / 2) / currentScale;
             initialY = (canvasContainer.scrollTop + containerRect.height / 2) / currentScale;
        }
        initialX = Math.max(20, initialX - initialWidth / 2 + (Math.random() - 0.5) * 50);
        initialY = Math.max(20, initialY - initialHeight / 2 + (Math.random() - 0.5) * 50);
        const newCard = {
            id: crypto.randomUUID(), type: type,
            title: `Nueva ${getSpanishTypeName(type)}`,
            x: initialX, y: initialY,
            width: initialWidth, height: initialHeight,
            color: getRandomColor(), tags: [],
            content: '',
            imageUrl: (type === 'image' ? '' : undefined)
        };
        if (type !== 'image') delete newCard.imageUrl;
        cards.push(newCard);
        renderCard(newCard);
        saveData();
    }

    function deleteCard(cardId) {
        connections = connections.filter(conn => {
            const shouldRemove = conn.fromId === cardId || conn.toId === cardId;
            if (shouldRemove) { const lineElement = connectionSvg?.querySelector(`line[data-connection-id="${conn.id}"]`); if (lineElement) lineElement.remove(); }
            return !shouldRemove;
        });
        cards = cards.filter(card => card.id !== cardId);
        const cardElement = canvasContent?.querySelector(`.card[data-id="${cardId}"]`);
        if (cardElement) cardElement.remove();
        saveData();
    }

    function updateCardData(cardId, updates) {
        const cardIndex = cards.findIndex(card => card.id === cardId);
        if (cardIndex > -1) {
            Object.assign(cards[cardIndex], updates);
            saveData();
            if (updates.x !== undefined || updates.y !== undefined || updates.width !== undefined || updates.height !== undefined) { updateLinesForCard(cardId); }
        } else { console.warn(`Tarjeta no encontrada para actualizar: ${cardId}`); }
    }

    // --- Funcionalidad de Drag and Drop ---
    function startDrag(e) {
        if (e.target.classList.contains('image-url-input')) return;
        if (e.button !== 0 || e.target.isContentEditable || e.target.tagName === 'TEXTAREA' || e.target.closest('.card-control-btn') || e.target.closest('.resize-handle')) { return; }
        if (connectingCardId || !canvasContent) return;
        activeCard = e.currentTarget; activeCard.classList.add('dragging'); isDragging = true;
        const rect = activeCard.getBoundingClientRect();
        dragOffsetX = (e.clientX - rect.left) / currentScale; dragOffsetY = (e.clientY - rect.top) / currentScale;
        document.addEventListener('mousemove', drag); document.addEventListener('mouseup', stopDrag, { once: true });
        document.body.style.userSelect = 'none';
    }
    function drag(e) {
        if (!isDragging || !activeCard || !canvasContent) return; e.preventDefault();
        const canvasRect = canvasContent.getBoundingClientRect();
        let newX = (e.clientX - canvasRect.left) / currentScale - dragOffsetX; let newY = (e.clientY - canvasRect.top) / currentScale - dragOffsetY;
        activeCard.style.left = `${newX}px`; activeCard.style.top = `${newY}px`;
        updateLinesForCard(activeCard.dataset.id);
    }
    function stopDrag() {
        if (!isDragging || !activeCard) return; isDragging = false;
        const cardId = activeCard.dataset.id; const finalX = parseFloat(activeCard.style.left || '0'); const finalY = parseFloat(activeCard.style.top || '0');
        activeCard.classList.remove('dragging'); updateCardData(cardId, { x: finalX, y: finalY });
        document.removeEventListener('mousemove', drag); document.body.style.userSelect = ''; activeCard = null;
    }

    // --- Funcionalidad de Redimensionamiento ---
    function startResize(e) {
        if (e.button !== 0 || !canvasContent) return; e.stopPropagation();
        isResizing = true; resizingCard = e.target.closest('.card'); if (!resizingCard) return; resizingCard.classList.add('resizing');
        startX = e.clientX; startY = e.clientY; initialWidth = resizingCard.offsetWidth; initialHeight = resizingCard.offsetHeight;
        document.addEventListener('mousemove', doResize); document.addEventListener('mouseup', stopResize, { once: true });
        document.body.style.cursor = 'nwse-resize'; document.body.style.userSelect = 'none';
    }
    function doResize(e) {
        if (!isResizing || !resizingCard) return; e.preventDefault();
        const deltaX = (e.clientX - startX) / currentScale; const deltaY = (e.clientY - startY) / currentScale;
        let newWidth = Math.max(MIN_CARD_WIDTH, initialWidth + deltaX); let newHeight = Math.max(MIN_CARD_HEIGHT, initialHeight + deltaY);
        resizingCard.style.width = `${newWidth}px`; resizingCard.style.height = `${newHeight}px`;
        updateLinesForCard(resizingCard.dataset.id);
    }
    function stopResize() {
        if (!isResizing || !resizingCard) return; isResizing = false;
        const cardId = resizingCard.dataset.id; const finalWidth = parseFloat(resizingCard.style.width); const finalHeight = parseFloat(resizingCard.style.height);
        resizingCard.classList.remove('resizing'); updateCardData(cardId, { width: finalWidth, height: finalHeight });
        document.removeEventListener('mousemove', doResize); document.body.style.cursor = ''; document.body.style.userSelect = ''; resizingCard = null;
    }

    // --- Funcionalidad de Conexiones ---
    function startConnectionMode(fromCardId) {
        if (!canvasContent) return; if (connectingCardId) cancelConnectionMode();
        connectingCardId = fromCardId; document.body.classList.add('connecting-mode');
        canvasContent.querySelectorAll('.card').forEach(cardEl => { if (cardEl.dataset.id === fromCardId) cardEl.classList.add('is-connection-source'); else cardEl.classList.add('connection-candidate'); });
        document.addEventListener('keydown', cancelConnectionOnEscape, { once: true }); document.addEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true, once: true });
        console.log(`Modo conexión iniciado: ${fromCardId}`);
    }
    function handleCardClickForConnection(e) {
        if (!connectingCardId) return; const clickedCardElement = e.currentTarget; const toCardId = clickedCardElement.dataset.id;
        document.removeEventListener('keydown', cancelConnectionOnEscape); document.removeEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true });
        if (connectingCardId === toCardId) { console.log("Conexión cancelada: misma tarjeta."); } else {
            const existing = connections.find(c => (c.fromId === connectingCardId && c.toId === toCardId) || (c.fromId === toCardId && c.toId === connectingCardId));
            if (existing) { console.log("Conexión cancelada: ya existe."); } else {
                const newConnection = { id: crypto.randomUUID(), fromId: connectingCardId, toId: toCardId };
                connections.push(newConnection); renderLine(newConnection); console.log(`Conexión creada: ${connectingCardId} -> ${toCardId}`); saveData();
            }
        }
        cancelConnectionMode();
    }
    function cancelConnectionMode() {
        if (!connectingCardId && !document.body.classList.contains('connecting-mode')) return;
        console.log("Modo conexión finalizado/cancelado."); connectingCardId = null; document.body.classList.remove('connecting-mode');
        canvasContent?.querySelectorAll('.card.connection-candidate, .card.is-connection-source').forEach(el => el.classList.remove('connection-candidate', 'is-connection-source'));
        document.removeEventListener('keydown', cancelConnectionOnEscape); document.removeEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true });
    }
    function cancelConnectionOnEscape(e) { if (e.key === 'Escape') { console.log("Cancelado por Escape."); document.removeEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true }); cancelConnectionMode(); } else { document.addEventListener('keydown', cancelConnectionOnEscape, { once: true }); } }
    function cancelConnectionOnClickOutside(e) {
        document.removeEventListener('keydown', cancelConnectionOnEscape);
        if (!e.target.closest('.card')) { console.log("Cancelado por click fuera."); cancelConnectionMode(); } else {
            const clickedOriginBtn = e.target.closest(`.card[data-id="${connectingCardId}"] .card-connect-btn`);
            if(clickedOriginBtn) { document.addEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true, once: true }); document.addEventListener('keydown', cancelConnectionOnEscape, { once: true }); }
        }
    }
    function deleteConnection(connectionId) {
        connections = connections.filter(conn => conn.id !== connectionId); const line = connectionSvg?.querySelector(`line[data-connection-id="${connectionId}"]`); if (line) line.remove(); saveData(); console.log(`Conexión eliminada: ${connectionId}`);
    }

    // --- Funcionalidad de Zoom ---
    function applyZoom() { if (canvasContent) canvasContent.style.transform = `scale(${currentScale})`; if (scaleLabel) scaleLabel.textContent = `${Math.round(currentScale * 100)}%`; if (connectionSvg) renderAllLines(); }
    function zoom(direction) {
        const step = 0.1; let prev = currentScale;
        if (direction === 'in') currentScale = Math.min(MAX_ZOOM, currentScale + step); else if (direction === 'out') currentScale = Math.max(MIN_ZOOM, currentScale - step);
        currentScale = Math.round(currentScale * 100) / 100;
        if (currentScale !== prev) { applyZoom(); saveData(); console.log(`Zoom: ${scaleLabel.textContent}`); }
    }

    // --- Funcionalidad de Importación/Exportación ---
    function exportToJson() {
        try {
            const data = { version: STORAGE_KEY, timestamp: new Date().toISOString(), cards: cards, connections: connections, scale: currentScale };
            const str = JSON.stringify(data, null, 2); const uri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(str);
            const name = `storycanvas_export_${new Date().toISOString().slice(0,10)}.json`;
            const link = document.createElement('a'); link.setAttribute('href', uri); link.setAttribute('download', name);
            document.body.appendChild(link); link.click(); document.body.removeChild(link); console.log("Exportación iniciada.");
        } catch (e) { console.error("Error exportación:", e); alert("Error al exportar."); }
    }
    function handleFileImport(event) {
        const file = event.target.files ? event.target.files[0] : null; if (!file) return;
        if (!confirm("Importar reemplazará el lienzo actual. ¿Continuar?")) { if (importFileInput) importFileInput.value = null; return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target?.result; if (typeof content !== 'string') { alert("Error lectura archivo."); if (importFileInput) importFileInput.value = null; return; }
            try {
                const data = JSON.parse(content);
                if (typeof data !== 'object' || data === null || !Array.isArray(data.cards) || !Array.isArray(data.connections) || typeof data.scale !== 'number' || data.scale < MIN_ZOOM || data.scale > MAX_ZOOM) { throw new Error("Formato inválido."); }
                data.cards.forEach((card, i) => {
                    if (!card.id || typeof card.x!=='number' || typeof card.y!=='number' || typeof card.width!=='number' || typeof card.height!=='number' || typeof card.type!=='string' || typeof card.title!=='string') { throw new Error(`Datos inválidos tarjeta ${i+1}.`); }
                    card.color = card.color || getRandomColor(); card.width = Math.max(MIN_CARD_WIDTH, card.width); card.height = Math.max(MIN_CARD_HEIGHT, card.height);
                    card.content = card.content || ''; // Asegurar content
                    if (card.type === 'image') card.imageUrl = card.imageUrl || ''; else card.imageUrl = undefined;
                });
                data.connections.forEach((conn, i) => { if (!conn.id || !conn.fromId || !conn.toId) { throw new Error(`Datos inválidos conexión ${i+1}.`); } if (!data.cards.some(c=>c.id===conn.fromId) || !data.cards.some(c=>c.id===conn.toId)) { console.warn(`Conexión ${conn.id} inválida.`); } });
                data.connections = data.connections.filter(conn => data.cards.some(c=>c.id===conn.fromId) && data.cards.some(c=>c.id===conn.toId));
                cards = data.cards; connections = data.connections; currentScale = data.scale;
                console.log("Importado."); alert("Importado con éxito.");
                renderAllCards(); applyZoom(); saveData();
            } catch (err) { console.error("Error importación:", err); alert(`Error: ${err.message || 'Formato inválido.'}`);
            } finally { if (importFileInput) importFileInput.value = null; }
        };
        reader.onerror = (e) => { console.error("Error lectura:", e); alert("Error al leer archivo."); if (importFileInput) importFileInput.value = null; };
        reader.readAsText(file);
    }

    // --- Limpiar Almacenamiento ---
    function clearStorage() {
        if (confirm("⚠️ ¿Borrar TODO el progreso? ¡No se puede deshacer!")) {
            try { localStorage.removeItem(STORAGE_KEY); resetState(); renderAllCards(); applyZoom(); alert("Lienzo limpiado."); console.log("LocalStorage limpiado."); showSaveIndicator(false); }
            catch (e) { console.error("Error limpiar:", e); alert("Error al borrar datos."); }
        }
    }
    // --- Utilidades ---
    function getRandomColor() { const c = ['#FFFFFF', '#FFF1F0', '#F0FFF4', '#F0F9FF', '#FAF5FF', '#FFFBEB', '#FFF8F4']; if (Math.random() < 0.5) return '#FFFFFF'; return c[Math.floor(Math.random() * c.length)]; }

    // --- Inicialización y Event Listeners ---
    console.log("Inicializando..."); loadData();
    if (addCardButtons.length > 0) { addCardButtons.forEach(b => { b.addEventListener('click', () => { if (b.dataset.type) addCard(b.dataset.type); }); }); } else { console.warn("Botones añadir no encontrados."); }
    if (zoomInBtn && zoomOutBtn) { zoomInBtn.addEventListener('click', () => zoom('in')); zoomOutBtn.addEventListener('click', () => zoom('out')); canvasContainer?.addEventListener('wheel', (e) => { e.preventDefault(); if (e.deltaY < 0) zoom('in'); else zoom('out'); }, { passive: false }); } else { console.warn("Botones zoom no encontrados."); }
    if (exportBtn) exportBtn.addEventListener('click', exportToJson); else { console.warn("Botón exportar no encontrado."); }
    if (importBtn && importFileInput) { importBtn.addEventListener('click', () => importFileInput.click()); importFileInput.addEventListener('change', handleFileImport); } else { console.warn("Elementos importación no encontrados."); }
    if (clearStorageBtn) clearStorageBtn.addEventListener('click', clearStorage); else { console.warn("Botón limpiar no encontrado."); }
    window.addEventListener('beforeunload', () => { if(saveTimeout) { clearTimeout(saveTimeout); try { const d = { cards: cards, connections: connections, scale: currentScale }; localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); console.log("Guardado forzado."); } catch (e) { console.error("Error guardado forzado:", e); } } });
    console.log("Listo.");
});
</script>

</body>
</html>
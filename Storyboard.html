<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryCanvas - Tablero Digital para Autoras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            overscroll-behavior: none;
            font-family: sans-serif;
        }
        .canvas-container {
            width: 100%;
            height: calc(100vh - 70px); /* Altura ajustada al header */
            position: relative;
            overflow: auto; /* Cambiado a auto para permitir scroll */
            background-color: #f8fafc; /* gris muy claro */
            background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 8px;
        }
        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 3000px; /* Tamaño aumentado para permitir desplazamiento */
            height: 3000px; /* Tamaño aumentado para permitir desplazamiento */
            transform-origin: top left; /* Origen del zoom */
            transition: transform 0.2s ease-out;
            z-index: 1; /* Detrás de tarjetas */
        }
        #connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 3000px; /* Coincide con canvas-content */
            height: 3000px;
            pointer-events: none; /* Permite clicks a través */
            z-index: 5; /* Encima del fondo, debajo de tarjetas */
            overflow: visible; /* Permite líneas fuera del viewport inicial */
        }
        #connection-svg line {
            stroke: #94a3b8; /* slate-400 */
            stroke-width: 2;
            cursor: pointer;
            pointer-events: stroke; /* Clickeable solo la línea */
            transition: stroke 0.2s, stroke-width 0.2s;
        }
         #connection-svg line:hover {
             stroke: #ef4444; /* red-500 */
             stroke-width: 4;
         }
         /* --- Estilos de Tarjeta --- */
        .card {
            position: absolute;
            min-width: 150px;
            min-height: 150px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: move;
            transition: box-shadow 0.2s, transform 0.1s;
            overflow: visible; /* Para el handle */
            display: flex;
            flex-direction: column;
            z-index: 10;
            border: 1px solid #e5e7eb; /* gray-200 */
            width: 250px; /* Default */
            height: 280px; /* Default (imagen + texto) */
        }
        .card.dragging { z-index: 1000; cursor: grabbing; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card.resizing { z-index: 1000; cursor: nwse-resize; user-select: none; }
        .card-header { padding: 6px 10px; border-bottom: 1px solid #e5e7eb; font-weight: 600; background-color: rgba(249, 250, 251, 0.8); display: flex; justify-content: space-between; align-items: center; cursor: grab; border-radius: 8px 8px 0 0; }
        .card:active .card-header { cursor: grabbing; }
        .card-header-title { flex-grow: 1; margin-right: 8px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; outline: none; cursor: text; } /* Añadido cursor: text */
        .card-header-title:focus { white-space: normal; text-overflow: clip; }
        .card-header-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .card-control-btn { cursor: pointer; color: #6b7280; font-size: 13px; padding: 3px; line-height: 1; transition: color 0.2s; }
        .card-control-btn:hover { color: #1f2937; }
        .card-delete-btn:hover { color: #ef4444; }
        .card-connect-btn:hover { color: #3b82f6; }
        .card-color-btn:hover { opacity: 0.8; }
        
        .card-body {
            padding: 10px 12px; /* Padding por defecto para texto */
            font-size: 13px;
            line-height: 1.4;
            flex-grow: 1; /* Ocupa espacio disponible */
            overflow: hidden; /* Oculta scroll del div body */
            display: flex;
            flex-direction: column;
        }
        .card[data-card-type="image"] .card-body {
             padding: 0; /* Sin padding general para imagen */
        }
        
        /* Textarea para tarjetas NO imagen */
        .card:not([data-card-type="image"]) .card-body textarea {
            width: 100%; border: none; padding: 0; font-size: 13px; line-height: inherit; flex-grow: 1; resize: none; background-color: transparent; min-height: 40px; outline: none; overflow-y: auto; cursor: text; /* Añadido cursor: text */
        }
        
        /* Elementos específicos tarjeta Imagen */
        .image-url-input { width: 100%; border: none; border-bottom: 1px solid #e5e7eb; padding: 8px 12px; font-size: 12px; outline: none; box-sizing: border-box; flex-shrink: 0; background-color: #f9fafc; cursor: text; } /* Añadido cursor: text */
        .image-url-input:focus { border-bottom: 1px solid #3b82f6; }
        .image-display-container { flex-grow: 1; position: relative; background-color: #e5e7eb; background-size: contain; background-position: center center; background-repeat: no-repeat; overflow: hidden; min-height: 100px; display: flex; align-items: center; justify-content: center; }
        .image-display-container::before { content: '\f03e'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 30px; color: #9ca3af; opacity: 0.5; }
        .image-display-container[style*="background-image: url"]::before { display: none; }
        
        /* Textarea para tarjeta Imagen */
         .card[data-card-type="image"] .card-body textarea {
             width: 100%; border: none; border-top: 1px solid #e5e7eb; padding: 8px 12px; font-size: 13px; line-height: 1.4; flex-shrink: 0; resize: none; background-color: #ffffff; min-height: 60px; max-height: 120px; outline: none; overflow-y: auto; box-sizing: border-box; cursor: text; /* Añadido cursor: text */
         }
        
        .card-footer { padding: 5px 10px; font-size: 11px; color: #6b7280; border-top: 1px solid #e5e7eb; flex-shrink: 0; border-radius: 0 0 8px 8px; background-color: #f9fafc; }
        .resize-handle { position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; background-color: rgba(150, 150, 150, 0.6); border: 1px solid rgba(255, 255, 255, 0.9); border-radius: 0 0 8px 0; cursor: nwse-resize; z-index: 11; transition: background-color 0.2s; }
        .resize-handle:hover { background-color: rgba(100, 100, 100, 0.8); }
        .color-picker-wrapper { position: relative; display: inline-block; }
        .card-color-btn { width: 18px; height: 18px; border-radius: 50%; border: 1px solid #d1d5db; cursor: pointer; display: inline-block; vertical-align: middle; transition: transform 0.1s; }
        .card-color-btn:hover { transform: scale(1.1); }
        .native-color-picker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 12; }
        body.connecting-mode { cursor: crosshair; }
        .card.connection-candidate { outline: 2px dashed #60a5fa; outline-offset: 3px; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
        .card.is-connection-source { outline: 2px solid #3b82f6; outline-offset: 3px; }
        .zoom-controls { position: fixed; bottom: 16px; right: 16px; z-index: 50; background: white; border-radius: 8px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); display: flex; flex-direction: column; overflow: hidden; }
        .zoom-btn { padding: 10px 14px; border: none; background: none; cursor: pointer; font-size: 16px; color: #374151; transition: background-color 0.2s; }
        .zoom-btn:hover { background-color: #f3f4f6; }
        .zoom-btn:first-child { border-bottom: 1px solid #e5e7eb; }
        .zoom-btn:active { background-color: #e5e7eb; }
        .canvas-scale { position: fixed; bottom: 16px; left: 16px; background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; color: #374151; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); z-index: 50; }
        .hidden-file-input { display: none; }
        #save-indicator { transition: background-color 0.3s, opacity 0.3s; }
        .hidden { display: none !important; }
        
        /* --- Estilos Aviso Escritorio --- */
        #desktop-warning {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.85); color: white; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #desktop-warning.visible { opacity: 1; visibility: visible; }
        #desktop-warning i { font-size: 3rem; margin-bottom: 1rem; color: #fde047; }
        #desktop-warning p { font-size: 1.1rem; line-height: 1.6; max-width: 500px; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <!-- Aviso solo Escritorio -->
    <div id="desktop-warning">
        <div>
            <i class="fas fa-desktop"></i>
            <p>
                StoryCanvas está optimizado para pantallas más grandes.
                Para una mejor experiencia, por favor, utiliza un ordenador de escritorio o una tablet en modo horizontal.
            </p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-md flex-shrink-0 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-feather-alt text-2xl"></i>
                <h1 class="text-xl font-semibold">StoryCanvas</h1>
            </div>
            <div class="flex items-center space-x-3">
                
                <button id="save-indicator" class="px-3 py-1.5 text-sm bg-indigo-600 rounded-md flex items-center opacity-50 cursor-not-allowed">
                    <i class="fas fa-check mr-1.5 text-xs"></i> Guardado
                </button>
                
                <button id="import-btn" title="Importar desde archivo JSON" class="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-500 rounded-md flex items-center transition-colors">
                    <i class="fas fa-file-import mr-1.5"></i> Importar
                </button>
                <button id="export-btn" title="Exportar lienzo a archivo JSON" class="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-500 rounded-md flex items-center transition-colors">
                    <i class="fas fa-file-export mr-1.5"></i> Exportar
                </button>
                <input type="file" id="import-file-input" class="hidden-file-input" accept=".json,application/json">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden p-4">
        <!-- Sidebar -->
        <aside class="w-60 bg-white rounded-lg shadow p-4 mr-4 flex-shrink-0 flex flex-col self-start sticky top-[60px]">
            
            <div>
                <!-- <h2 class="text-base font-semibold mb-4 text-gray-700">Herramientas</h2> -->
                <div class="mb-5">
                    <h3 class="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wider">Añadir Tarjeta al proyecto</h3>
                    <button id="add-chapter-btn" data-type="chapter" class="add-card-btn w-full p-2 text-sm bg-purple-50 hover:bg-purple-100 rounded-md text-purple-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-book-open mr-2 w-4 text-center"></i> Capítulo
                    </button>
                    <button id="add-scene-btn" data-type="scene" class="add-card-btn w-full p-2 text-sm bg-blue-50 hover:bg-blue-100 rounded-md text-blue-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-film mr-2 w-4 text-center"></i> Escena
                    </button>
                    <button id="add-idea-btn" data-type="idea" class="add-card-btn w-full p-2 text-sm bg-green-50 hover:bg-green-100 rounded-md text-green-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-lightbulb mr-2 w-4 text-center"></i> Idea
                    </button>
                    <button id="add-image-btn" data-type="image" class="add-card-btn w-full p-2 text-sm bg-orange-50 hover:bg-orange-100 rounded-md text-orange-700 mb-2 flex items-center transition-colors">
                        <i class="fas fa-image mr-2 w-4 text-center"></i> Imagen
                    </button>
                </div>
            
            </div>
            
            <div class="mt-auto border-t pt-4">
                
                <button id="clear-storage-btn" title="Borrar todo el contenido del lienzo" class="w-full p-2 text-sm bg-red-50 hover:bg-red-100 text-red-700 rounded-md flex items-center justify-center transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i> Limpiar Todo
                </button>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="flex-1 relative">
            <div id="free-view" class="canvas-container">
                <div id="canvas-content-free" class="canvas-content">
                    
                    <svg id="connection-svg"></svg>
                </div>
                <div class="zoom-controls">
                    <button id="zoom-in" title="Acercar" class="zoom-btn"><i class="fas fa-search-plus"></i></button>
                    <button id="zoom-out" title="Alejar" class="zoom-btn"><i class="fas fa-search-minus"></i></button>
                </div>
                <div id="canvas-scale-label" class="canvas-scale">100%</div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const STORAGE_KEY = 'storyCanvasData_v5'; // Clave para localStorage
    
    // --- Referencias a elementos del DOM ---
    const canvasContainer = document.getElementById('free-view');
    const canvasContent = document.getElementById('canvas-content-free');
    const connectionSvg = document.getElementById('connection-svg');
    const addCardButtons = document.querySelectorAll('.add-card-btn');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const scaleLabel = document.getElementById('canvas-scale-label');
    const clearStorageBtn = document.getElementById('clear-storage-btn');
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importFileInput = document.getElementById('import-file-input');
    const saveIndicator = document.getElementById('save-indicator');
    const desktopWarning = document.getElementById('desktop-warning');
    
    // --- Estado de la aplicación ---
    let cards = []; let connections = []; let activeCard = null; let resizingCard = null; let connectingCardId = null;
    let startX, startY, initialWidth, initialHeight; let dragOffsetX, dragOffsetY;
    let currentScale = 1.0; let isDragging = false; let isResizing = false; let saveTimeout = null;
    
    // --- Constantes y Configuraciones ---
    const typeTranslations = { scene: "Escena", chapter: "Capítulo", idea: "Idea", image: "Imagen" };
    const MIN_CARD_WIDTH = 150; const MIN_CARD_HEIGHT = 150; const MAX_ZOOM = 3.0; const MIN_ZOOM = 0.2;
    const MIN_DESKTOP_WIDTH = 1024; // Umbral para aviso de escritorio
    const SAVE_DEBOUNCE_MS = 700; // Tiempo de espera para guardar
    const RESIZE_DEBOUNCE_MS = 250; // Tiempo de espera para checkear resize
    
    function getSpanishTypeName(type) { return typeTranslations[type] || type; }
    
    // --- Funciones de Guardado y Carga ---
    function showSaveIndicator(saving = false) {
        if (!saveIndicator) return;
        if (saving) {
            saveIndicator.innerHTML = '<i class="fas fa-save mr-1.5 text-xs animate-spin"></i> Guardando...';
            saveIndicator.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-indigo-600');
            saveIndicator.classList.add('bg-yellow-500');
        } else {
            saveIndicator.innerHTML = '<i class="fas fa-check mr-1.5 text-xs"></i> Guardado';
            saveIndicator.classList.add('opacity-50', 'cursor-not-allowed', 'bg-indigo-600');
            saveIndicator.classList.remove('bg-yellow-500');
        }
    }
    
    function saveData() {
        clearTimeout(saveTimeout);
        showSaveIndicator(true);
        saveTimeout = setTimeout(() => {
            try {
                const dataToSave = { cards: cards, connections: connections, scale: currentScale };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('Datos guardados:', new Date().toLocaleTimeString());
                showSaveIndicator(false);
            } catch (error) {
                console.error("Error al guardar:", error); alert("Error al guardar. Almacenamiento lleno?"); showSaveIndicator(false);
            }
        }, SAVE_DEBOUNCE_MS);
    }
    
    function loadData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const parsedData = JSON.parse(savedData);
                cards = parsedData.cards || [];
                connections = parsedData.connections || [];
                currentScale = parsedData.scale || 1.0;
                
                // Validar y aplicar valores por defecto
                cards.forEach(card => {
                    card.width = card.width >= MIN_CARD_WIDTH ? card.width : (card.type === 'image' ? 250 : MIN_CARD_WIDTH);
                    card.height = card.height >= MIN_CARD_HEIGHT ? card.height : (card.type === 'image' ? 280 : MIN_CARD_HEIGHT);
                    card.color = card.color || getRandomColor();
                    card.title = card.title || `Sin título`;
                    card.type = card.type || 'idea';
                    card.x = typeof card.x === 'number' ? card.x : 50;
                    card.y = typeof card.y === 'number' ? card.y : 50;
                    card.content = card.content || ''; // Asegurar que content exista
                    if (card.type === 'image') {
                        card.imageUrl = card.imageUrl || ''; // Asegurar que imageUrl exista si es imagen
                    } else if (card.imageUrl !== undefined) {
                        delete card.imageUrl; // Limpiar imageUrl si no es tipo imagen
                    }
                });
                connections = connections.filter(conn => conn.id && conn.fromId && conn.toId);
                console.log('Datos cargados.');
            } catch (error) {
                console.error("Error al parsear datos:", error); alert("Error al cargar datos. Empezando lienzo vacío."); resetState();
            }
        } else {
            console.log('No hay datos guardados. Empezando lienzo vacío.'); resetState();
        }
        renderAllCards();
        applyZoom();
    }
    
    function resetState() { cards = []; connections = []; currentScale = 1.0; }
    
    // --- Funciones de Renderizado ---
    function renderCard(cardData) {
        if (!canvasContent) return;
        const cardElement = document.createElement('div');
        cardElement.className = 'card'; cardElement.dataset.id = cardData.id; cardElement.dataset.cardType = cardData.type;
        cardElement.style.left = `${cardData.x}px`; cardElement.style.top = `${cardData.y}px`; cardElement.style.width = `${cardData.width}px`; cardElement.style.height = `${cardData.height}px`; cardElement.style.backgroundColor = cardData.color;
        
        // Header
        const cardHeader = document.createElement('div'); cardHeader.className = 'card-header';
        const titleSpan = document.createElement('span'); titleSpan.className = 'card-header-title'; titleSpan.textContent = cardData.title; titleSpan.contentEditable = true; titleSpan.spellcheck = false;
        titleSpan.addEventListener('blur', (e) => { if (e.target instanceof HTMLElement) updateCardData(cardData.id, { title: e.target.textContent || 'Sin título' }); });
        titleSpan.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); if (e.target instanceof HTMLElement) e.target.blur(); } });
        titleSpan.addEventListener('mousedown', (e) => e.stopPropagation());
        const headerControls = document.createElement('div'); headerControls.className = 'card-header-controls';
        // Color Picker
        const cpWrap = document.createElement('div'); cpWrap.className = 'color-picker-wrapper'; const cBtn = document.createElement('span'); cBtn.className = 'card-color-btn card-control-btn'; cBtn.style.backgroundColor = cardData.color; cBtn.title = 'Color'; const nativeCp = document.createElement('input'); nativeCp.type = 'color'; nativeCp.className = 'native-color-picker'; nativeCp.value = cardData.color; nativeCp.addEventListener('input', (e) => { if (e.target instanceof HTMLInputElement) { cardElement.style.backgroundColor = e.target.value; cBtn.style.backgroundColor = e.target.value; } }); nativeCp.addEventListener('change', (e) => { if (e.target instanceof HTMLInputElement) updateCardData(cardData.id, { color: e.target.value }); }); nativeCp.addEventListener('mousedown', (e) => e.stopPropagation()); cpWrap.appendChild(cBtn); cpWrap.appendChild(nativeCp); headerControls.appendChild(cpWrap);
        // Connect Button
        const connectBtn = document.createElement('i'); connectBtn.className = 'fas fa-link card-connect-btn card-control-btn'; connectBtn.title = 'Conectar'; connectBtn.addEventListener('click', (e) => { e.stopPropagation(); startConnectionMode(cardData.id); }); headerControls.appendChild(connectBtn);
        // Delete Button
        const deleteBtn = document.createElement('i'); deleteBtn.className = 'fas fa-trash-alt card-delete-btn card-control-btn'; deleteBtn.title = 'Eliminar'; deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`¿Eliminar "${cardData.title}"?`)) deleteCard(cardData.id); }); headerControls.appendChild(deleteBtn);
        cardHeader.appendChild(titleSpan); cardHeader.appendChild(headerControls);
        
        // Body
        const cardBody = document.createElement('div'); cardBody.className = 'card-body';
        // Textarea (siempre presente)
        const contentTextarea = document.createElement('textarea'); contentTextarea.placeholder = 'Notas...'; contentTextarea.value = cardData.content || '';
        contentTextarea.addEventListener('change', (e) => { if (e.target instanceof HTMLTextAreaElement) updateCardData(cardData.id, { content: e.target.value }); });
        contentTextarea.addEventListener('mousedown', (e) => e.stopPropagation());
        
        if (cardData.type === 'image') {
            // Image specific elements
            const urlInput = document.createElement('input'); urlInput.type = 'url'; urlInput.className = 'image-url-input'; urlInput.placeholder = 'URL Imagen...'; urlInput.value = cardData.imageUrl || ''; urlInput.spellcheck = false;
            urlInput.addEventListener('mousedown', (e) => e.stopPropagation());
            const imageDisplay = document.createElement('div'); imageDisplay.className = 'image-display-container';
            if (cardData.imageUrl) setImageBackground(imageDisplay, cardData.imageUrl);
            urlInput.addEventListener('change', (e) => { if (e.target instanceof HTMLInputElement) { const url = e.target.value.trim(); updateCardData(cardData.id, { imageUrl: url }); setImageBackground(imageDisplay, url); } });
            // Add image elements first, then textarea
            cardBody.appendChild(urlInput); cardBody.appendChild(imageDisplay); cardBody.appendChild(contentTextarea);
        } else {
            // For non-image types, just add the textarea
            cardBody.appendChild(contentTextarea);
        }
        
        // Footer
        const cardFooter = document.createElement('div'); cardFooter.className = 'card-footer'; const typeSpan = document.createElement('span'); typeSpan.textContent = getSpanishTypeName(cardData.type); cardFooter.appendChild(typeSpan);
        // Resize Handle
        const resizeHandle = document.createElement('div'); resizeHandle.className = 'resize-handle'; resizeHandle.addEventListener('mousedown', startResize);
        
        // Assemble Card
        cardElement.appendChild(cardHeader); cardElement.appendChild(cardBody); cardElement.appendChild(cardFooter); cardElement.appendChild(resizeHandle);
        // Global Card Events
        cardElement.addEventListener('click', handleCardClickForConnection); cardElement.addEventListener('mousedown', startDrag);
        canvasContent.appendChild(cardElement); // Add to DOM
    }
    
    function setImageBackground(element, url) {
        if (!url) { element.style.backgroundImage = ''; return; }
        const img = new Image(); img.onload = () => { element.style.backgroundImage = `url('${url}')`; console.log(`Img OK: ${url.substring(0, 50)}...`); }; img.onerror = () => { element.style.backgroundImage = ''; console.warn(`Img Error: ${url.substring(0, 50)}...`); }; img.src = url;
    }
    function renderAllCards() { if (!canvasContent || !connectionSvg) return; canvasContent.querySelectorAll('.card').forEach(n => n.remove()); connectionSvg.innerHTML = ''; cards.forEach(renderCard); renderAllLines(); }
    
    // --- Líneas de Conexión ---
    function renderLine(conn) {
        if (!canvasContent || !connectionSvg) return; const from = canvasContent.querySelector(`.card[data-id="${conn.fromId}"]`); const to = canvasContent.querySelector(`.card[data-id="${conn.toId}"]`); if (!from || !to) return;
        const x1=from.offsetLeft+from.offsetWidth/2, y1=from.offsetTop+from.offsetHeight/2, x2=to.offsetLeft+to.offsetWidth/2, y2=to.offsetTop+to.offsetHeight/2;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',x1); line.setAttribute('y1',y1); line.setAttribute('x2',x2); line.setAttribute('y2',y2); line.dataset.connectionId = conn.id;
        line.addEventListener('click', (e) => { e.stopPropagation(); if (confirm('¿Eliminar conexión?')) deleteConnection(conn.id); }); connectionSvg.appendChild(line);
    }
    function renderAllLines() { if (!connectionSvg) return; connectionSvg.innerHTML = ''; connections.forEach(renderLine); }
    function updateLinesForCard(cardId) { if (!connectionSvg) return; connections.forEach(conn => { if (conn.fromId === cardId || conn.toId === cardId) { const line = connectionSvg.querySelector(`line[data-connection-id="${conn.id}"]`); if (line) line.remove(); renderLine(conn); } }); }
    
    // --- Manipulación de Tarjetas ---
    function addCard(type) {
        const cRect = canvasContainer?.getBoundingClientRect(); let x=50, y=50; let w=250, h=(type==='image'?280:180);
        if(cRect){ x = (canvasContainer.scrollLeft+cRect.width/2)/currentScale; y = (canvasContainer.scrollTop+cRect.height/2)/currentScale; }
        x = Math.max(20,x-w/2+(Math.random()-0.5)*50); y = Math.max(20,y-h/2+(Math.random()-0.5)*50);
        const card = { id: crypto.randomUUID(), type: type, title: `Nueva ${getSpanishTypeName(type)}`, x: x, y: y, width: w, height: h, color: getRandomColor(), tags: [], content: '', imageUrl: (type === 'image' ? '' : undefined) };
        if (type !== 'image') delete card.imageUrl;
        cards.push(card); renderCard(card); saveData();
    }
    function deleteCard(cardId) {
        connections = connections.filter(c => { const rm = c.fromId===cardId || c.toId===cardId; if(rm){const l=connectionSvg?.querySelector(`line[data-connection-id="${c.id}"]`); if(l) l.remove();} return !rm; });
        cards = cards.filter(c => c.id !== cardId); const el = canvasContent?.querySelector(`.card[data-id="${cardId}"]`); if (el) el.remove(); saveData();
    }
    function updateCardData(cardId, updates) { const i = cards.findIndex(c => c.id === cardId); if (i > -1) { Object.assign(cards[i], updates); saveData(); if (updates.x!==undefined||updates.y!==undefined||updates.width!==undefined||updates.height!==undefined) updateLinesForCard(cardId); } else console.warn(`Update fail: Card ${cardId} not found`); }
    
    // --- Drag and Drop ---
    function startDrag(e) {
        // Evitar arrastre en elementos editables y controles
        if (e.target.classList.contains('image-url-input') || 
            e.target.tagName === 'TEXTAREA' || 
            e.target.classList.contains('card-header-title') || 
            e.target.closest('.card-control-btn') || 
            e.target.closest('.resize-handle')) return;
            
        if (e.button !== 0 || connectingCardId || !canvasContent) return;
        activeCard = e.currentTarget;
        activeCard.classList.add('dragging');
        isDragging = true;
        
        const rect = activeCard.getBoundingClientRect();
        dragOffsetX = (e.clientX - rect.left) / currentScale;
        dragOffsetY = (e.clientY - rect.top) / currentScale;
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag, { once: true });
        document.body.style.userSelect = 'none';
    }
    
    function drag(e) {
        if (!isDragging || !activeCard || !canvasContent) return;
        e.preventDefault();
        const cRect = canvasContent.getBoundingClientRect();
        
        let x = (e.clientX - cRect.left)/currentScale - dragOffsetX;
        let y = (e.clientY - cRect.top)/currentScale - dragOffsetY;
        
        // Limitar posición dentro del canvas
        x = Math.max(0, x);
        y = Math.max(0, y);
        
        activeCard.style.left = `${x}px`;
        activeCard.style.top = `${y}px`;
        updateLinesForCard(activeCard.dataset.id);
    }
    
    function stopDrag() {
        if (!isDragging || !activeCard) return;
        isDragging = false;
        const id = activeCard.dataset.id;
        const x = parseFloat(activeCard.style.left||'0');
        const y = parseFloat(activeCard.style.top||'0');
        
        activeCard.classList.remove('dragging');
        updateCardData(id, { x: x, y: y });
        
        document.removeEventListener('mousemove', drag);
        document.body.style.userSelect = '';
        activeCard = null;
    }
    
    // --- Redimensionamiento ---
    function startResize(e) { if (e.button !== 0 || !canvasContent) return; e.stopPropagation(); isResizing = true; resizingCard = e.target.closest('.card'); if (!resizingCard) return; resizingCard.classList.add('resizing'); startX = e.clientX; startY = e.clientY; initialWidth = resizingCard.offsetWidth; initialHeight = resizingCard.offsetHeight; document.addEventListener('mousemove', doResize); document.addEventListener('mouseup', stopResize, { once: true }); document.body.style.cursor = 'nwse-resize'; document.body.style.userSelect = 'none'; }
    function doResize(e) { if (!isResizing || !resizingCard) return; e.preventDefault(); const dX = (e.clientX - startX) / currentScale; const dY = (e.clientY - startY) / currentScale; let w = Math.max(MIN_CARD_WIDTH, initialWidth + dX); let h = Math.max(MIN_CARD_HEIGHT, initialHeight + dY); resizingCard.style.width = `${w}px`; resizingCard.style.height = `${h}px`; updateLinesForCard(resizingCard.dataset.id); }
    function stopResize() { if (!isResizing || !resizingCard) return; isResizing = false; const id = resizingCard.dataset.id; const w = parseFloat(resizingCard.style.width); const h = parseFloat(resizingCard.style.height); resizingCard.classList.remove('resizing'); updateCardData(id, { width: w, height: h }); document.removeEventListener('mousemove', doResize); document.body.style.cursor = ''; document.body.style.userSelect = ''; resizingCard = null; }
    
    // --- Conexiones ---
    function startConnectionMode(fromId) { if (!canvasContent) return; if (connectingCardId) cancelConnectionMode(); connectingCardId = fromId; document.body.classList.add('connecting-mode'); canvasContent.querySelectorAll('.card').forEach(el => { if (el.dataset.id === fromId) el.classList.add('is-connection-source'); else el.classList.add('connection-candidate'); }); document.addEventListener('keydown', cancelConnectionOnEscape, { once: true }); document.addEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true, once: true }); console.log(`Conn Mode ON: ${fromId}`); }
    function handleCardClickForConnection(e) { if (!connectingCardId) return; const toEl = e.currentTarget; const toId = toEl.dataset.id; document.removeEventListener('keydown', cancelConnectionOnEscape); document.removeEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true }); if (connectingCardId === toId) console.log("Conn Cancel: Self"); else { const exists = connections.find(c=>(c.fromId===connectingCardId&&c.toId===toId)||(c.fromId===toId&&c.toId===connectingCardId)); if(exists) console.log("Conn Cancel: Exists"); else { const conn={id:crypto.randomUUID(),fromId:connectingCardId,toId:toId}; connections.push(conn); renderLine(conn); console.log(`Conn OK: ${connectingCardId}->${toId}`); saveData(); } } cancelConnectionMode(); }
    function cancelConnectionMode() { if (!connectingCardId && !document.body.classList.contains('connecting-mode')) return; console.log("Conn Mode OFF"); connectingCardId = null; document.body.classList.remove('connecting-mode'); canvasContent?.querySelectorAll('.card.connection-candidate,.card.is-connection-source').forEach(el => el.classList.remove('connection-candidate','is-connection-source')); document.removeEventListener('keydown', cancelConnectionOnEscape); document.removeEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true }); }
    function cancelConnectionOnEscape(e) { if(e.key==='Escape'){console.log("Conn Cancel: Esc"); document.removeEventListener('mousedown',cancelConnectionOnClickOutside,{capture:true}); cancelConnectionMode();} else {document.addEventListener('keydown',cancelConnectionOnEscape,{once:true});} }
    function cancelConnectionOnClickOutside(e) { document.removeEventListener('keydown', cancelConnectionOnEscape); if (!e.target.closest('.card')) { console.log("Conn Cancel: Click Out"); cancelConnectionMode(); } else { const originBtn = e.target.closest(`.card[data-id="${connectingCardId}"] .card-connect-btn`); if(originBtn) { document.addEventListener('mousedown', cancelConnectionOnClickOutside, { capture: true, once: true }); document.addEventListener('keydown', cancelConnectionOnEscape, { once: true }); } } }
    function deleteConnection(connId) { connections = connections.filter(c => c.id !== connId); const line = connectionSvg?.querySelector(`line[data-connection-id="${connId}"]`); if (line) line.remove(); saveData(); console.log(`Conn Deleted: ${connId}`); }
    
    // --- Zoom ---
    function applyZoom() { if (canvasContent) canvasContent.style.transform = `scale(${currentScale})`; if (scaleLabel) scaleLabel.textContent = `${Math.round(currentScale * 100)}%`; if (connectionSvg) renderAllLines(); }
    function zoom(dir) { const step = 0.1; let prev = currentScale; if (dir === 'in') currentScale = Math.min(MAX_ZOOM, currentScale + step); else if (dir === 'out') currentScale = Math.max(MIN_ZOOM, currentScale - step); currentScale = Math.round(currentScale*100)/100; if (currentScale !== prev) { applyZoom(); saveData(); console.log(`Zoom: ${scaleLabel.textContent}`); } }
    
    // --- Import/Export ---
    function exportToJson() { try { const d={version:STORAGE_KEY,timestamp:new Date().toISOString(),cards:cards,connections:connections,scale:currentScale}; const s=JSON.stringify(d,null,2); const u='data:application/json;charset=utf-8,'+encodeURIComponent(s); const n=`storycanvas_${new Date().toISOString().slice(0,10)}.json`; const l=document.createElement('a'); l.setAttribute('href',u); l.setAttribute('download',n); document.body.appendChild(l); l.click(); document.body.removeChild(l); console.log("Export OK"); } catch(e){ console.error("Export Error:",e); alert("Error exportando."); } }
    function handleFileImport(event) {
        const file = event.target.files?.[0]; if (!file) return;
        if (!confirm("Importar reemplazará el lienzo. ¿Continuar?")) { if (importFileInput) importFileInput.value = null; return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target?.result; if (typeof content !== 'string') { alert("Error lectura."); if (importFileInput) importFileInput.value = null; return; }
            try {
                const data = JSON.parse(content);
                if (typeof data !== 'object' || data === null || !Array.isArray(data.cards) || !Array.isArray(data.connections) || typeof data.scale !== 'number' || data.scale < MIN_ZOOM || data.scale > MAX_ZOOM) throw new Error("Formato inválido.");
                data.cards.forEach((c,i) => { if (!c.id||typeof c.x!=='number'||typeof c.y!=='number'||typeof c.width!=='number'||typeof c.height!=='number'||typeof c.type!=='string'||typeof c.title!=='string') throw new Error(`Card ${i+1} inválida.`); c.color=c.color||getRandomColor(); c.width=Math.max(MIN_CARD_WIDTH,c.width); c.height=Math.max(MIN_CARD_HEIGHT,c.height); c.content=c.content||''; if(c.type==='image') c.imageUrl=c.imageUrl||''; else c.imageUrl=undefined; });
                data.connections.forEach((c,i) => { if (!c.id||!c.fromId||!c.toId) throw new Error(`Conn ${i+1} inválida.`); if (!data.cards.some(card=>card.id===c.fromId)||!data.cards.some(card=>card.id===c.toId)) console.warn(`Conn ${c.id} inválida (tarjeta no encontrada).`); });
                data.connections = data.connections.filter(conn => data.cards.some(c=>c.id===conn.fromId) && data.cards.some(c=>c.id===conn.toId));
                cards = data.cards; connections = data.connections; currentScale = data.scale;
                console.log("Import OK."); alert("Importado con éxito."); renderAllCards(); applyZoom(); saveData();
            } catch (err) { console.error("Import Error:", err); alert(`Error: ${err.message||'Formato inválido.'}`); }
            finally { if (importFileInput) importFileInput.value = null; }
        };
        reader.onerror = (e) => { console.error("Read Error:", e); alert("Error al leer archivo."); if (importFileInput) importFileInput.value = null; }; reader.readAsText(file);
    }
    
    // --- Limpiar Almacenamiento ---
    function clearStorage() { if (confirm("⚠️ ¿Borrar TODO? ¡No se puede deshacer!")) { try { localStorage.removeItem(STORAGE_KEY); resetState(); renderAllCards(); applyZoom(); alert("Lienzo limpiado."); console.log("Storage Cleared."); showSaveIndicator(false); } catch (e) { console.error("Clear Error:", e); alert("Error al borrar."); } } }
    // --- Utilidades ---
    function getRandomColor() { const c=['#FFFFFF','#FFF1F0','#F0FFF4','#F0F9FF','#FAF5FF','#FFFBEB','#FFF8F4']; if(Math.random()<0.5) return '#FFFFFF'; return c[Math.floor(Math.random()*c.length)]; }
    
    // --- Aviso Escritorio ---
    let resizeTimeout;
    function checkResolution() { if (!desktopWarning) return; const w = window.innerWidth; if (w < MIN_DESKTOP_WIDTH) desktopWarning.classList.add('visible'); else desktopWarning.classList.remove('visible'); }
    function debounce(func, wait) { let timeout; return function(...args){ const later=()=>{clearTimeout(timeout);func(...args);}; clearTimeout(timeout); timeout=setTimeout(later,wait); }; }
    
    // --- Inicialización y Event Listeners ---
    console.log("Inicializando..."); loadData(); checkResolution();
    if(addCardButtons.length>0) addCardButtons.forEach(b=>{b.addEventListener('click',()=>{if(b.dataset.type)addCard(b.dataset.type);});}); else console.warn("Add btns not found.");
    if(zoomInBtn&&zoomOutBtn){zoomInBtn.addEventListener('click',()=>zoom('in')); zoomOutBtn.addEventListener('click',()=>zoom('out')); canvasContainer?.addEventListener('wheel',(e)=>{e.preventDefault(); if(e.deltaY<0)zoom('in');else zoom('out');},{passive:false});} else console.warn("Zoom btns not found.");
    if(exportBtn) exportBtn.addEventListener('click',exportToJson); else console.warn("Export btn not found.");
    if(importBtn&&importFileInput){importBtn.addEventListener('click',()=>importFileInput.click()); importFileInput.addEventListener('change',handleFileImport);} else console.warn("Import elements not found.");
    if(clearStorageBtn) clearStorageBtn.addEventListener('click',clearStorage); else console.warn("Clear btn not found.");
    window.addEventListener('resize', debounce(checkResolution, RESIZE_DEBOUNCE_MS));
    window.addEventListener('beforeunload', () => { if(saveTimeout) { clearTimeout(saveTimeout); try { const d = { cards: cards, connections: connections, scale: currentScale }; localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); console.log("Forced save OK."); } catch (e) { console.error("Forced save Error:", e); } } });
    console.log("Listo.");
});
</script>

</body>
</html>
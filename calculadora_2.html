<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Autopublicación - Planifica tu libro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                    }
                }
            }
        }
    </script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-radio:checked + label,
        .custom-checkbox:checked + label {
            background-color: #4F46E5; color: white; border-color: #4F46E5;
        }
        .result-card { transition: all 0.3s ease; }
        .result-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text { visibility: hidden; width: 160px; background-color: #1F2937; color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -80px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1rem; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .tab-btn.active { color: var(--tw-color-primary); border-bottom: 2px solid var(--tw-color-primary); font-weight: 600; }
        input[readonly] { background-color: #F3F4F6; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <header class="bg-gradient-to-r from-primary to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">Calculadora de Autopublicación</h1>
                    <p class="text-lg opacity-90">Planifica los costes y beneficios de tu libro</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="window.print()" class="bg-white text-primary px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition flex items-center">
                        <i class="fas fa-print mr-2"></i> Imprimir
                    </button>
                    <button onclick="resetAll()" class="bg-accent text-white px-4 py-2 rounded-lg font-medium hover:bg-yellow-600 transition flex items-center">
                        <i class="fas fa-redo mr-2"></i> Reiniciar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
            <div class="flex overflow-x-auto border-b">
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-primary transition active" data-tab="basic">Datos Básicos</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-primary transition" data-tab="costs">Costes</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-primary transition" data-tab="pricing">Precio y Ventas</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-primary transition" data-tab="compare">Comparativa</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-primary transition" data-tab="results">Resultados</button>
            </div>

            <!-- Basic Info Tab -->
            <div id="basic" class="tab-content active p-6">
                <h2 class="text-2xl font-bold text-dark mb-6">Información Básica del Libro</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                     <div>
                        <label class="block text-gray-700 font-medium mb-2">Tipo de Libro</label>
                        <div class="flex space-x-4">
                            <div class="flex items-center">
                                <input type="radio" id="children" name="bookType" value="children" class="custom-radio hidden">
                                <label for="children" class="px-4 py-2 border rounded-lg cursor-pointer flex items-center text-sm sm:text-base">
                                    <i class="fas fa-child mr-2"></i> Infantil
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="novel" name="bookType" value="novel" class="custom-radio hidden" checked>
                                <label for="novel" class="px-4 py-2 border rounded-lg cursor-pointer flex items-center text-sm sm:text-base">
                                    <i class="fas fa-book mr-2"></i> Novela / Otros
                                </label>
                            </div>
                        </div>
                    </div>
                     <div>
                        <label class="block text-gray-700 font-medium mb-2">Formato de Publicación</label>
                        <div class="flex space-x-4">
                             <div class="flex items-center">
                                <input type="radio" id="kdp" name="publishingFormat" value="kdp" class="custom-radio hidden" checked>
                                <label for="kdp" class="px-4 py-2 border rounded-lg cursor-pointer flex items-center text-sm sm:text-base">
                                    <i class="fab fa-amazon mr-2"></i> Amazon KDP
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="traditional" name="publishingFormat" value="traditional" class="custom-radio hidden">
                                <label for="traditional" class="px-4 py-2 border rounded-lg cursor-pointer flex items-center text-sm sm:text-base">
                                    <i class="fas fa-print mr-2"></i> Imprenta
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label for="pageCount" class="block text-gray-700 font-medium mb-2">Número de páginas</label>
                        <input type="number" id="pageCount" min="24" max="1000" value="150" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label for="bookSize" class="block text-gray-700 font-medium mb-2">Tamaño del libro</label>
                        <select id="bookSize" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="12.7x20.32">5" x 8" (12.7 x 20.32 cm)</option>
                            <option value="13.97x21.59" selected>5.5" x 8.5" (13.97 x 21.59 cm)</option>
                            <option value="15.24x22.86">6" x 9" (15.24 x 22.86 cm)</option>
                             <option value="a5">A5 (14.8 x 21 cm)</option>
                             <option value="a4">A4 (21 x 29.7 cm)</option>
                             <option value="20.32x20.32">8" x 8" (20.32 x 20.32 cm Cuadrado)</option>
                             <option value="21.59x27.94">8.5" x 11" (21.59 x 27.94 cm)</option>
                         </select>
                    </div>
                     <div>
                        <label for="printType" class="block text-gray-700 font-medium mb-2">Tipo de impresión interior</label>
                        <select id="printType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="bw" selected>Blanco y negro</option>
                            <option value="color_standard">Color estándar</option>
                            <option value="color_premium">Color premium</option>
                        </select>
                         <p class="text-xs text-gray-500 mt-1">KDP usa estándar/premium, imprentas suelen ofrecer más opciones.</p>
                     </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="paperType" class="block text-gray-700 font-medium mb-2">Tipo de papel <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">KDP ofrece Blanco o Crema (B/N), Blanco (Color). Imprentas tienen más variedad. Selecciona el más parecido.</span></span></label>
                        <select id="paperType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="cream">Crema (B/N - KDP)</option>
                            <option value="white" selected>Blanco (B/N, Color - KDP)</option>
                            <option value="standard_80">Estándar (80-90 gr)</option>
                            <option value="premium_100">Premium (100-115 gr)</option>
                            <option value="coated_glossy">Estucado Brillo (Color)</option>
                            <option value="coated_matte">Estucado Mate (Color)</option>
                        </select>
                    </div>
                     <div>
                        <label for="bindingType" class="block text-gray-700 font-medium mb-2">Tipo de encuadernación</label>
                        <select id="bindingType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="soft_matte" selected>Tapa blanda Mate (KDP)</option>
                            <option value="soft_glossy">Tapa blanda Brillo (KDP)</option>
                            <option value="hard">Tapa dura (KDP & Imprenta)</option>
                             <option value="spiral">Espiral (Imprenta)</option>
                         </select>
                         <p class="text-xs text-gray-500 mt-1">KDP ofrece tapa blanda (mate/brillo) y dura. Imprentas varían.</p>
                    </div>
                </div>
                 <div class="flex justify-end">
                    <button onclick="navigateToTab('costs')" class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center">
                        Siguiente <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Costs Tab -->
            <div id="costs" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-dark mb-6">Costes de Producción</h2>
                 <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-pen-fancy mr-2 text-accent"></i> Servicios Editoriales
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label for="editingCost" class="block text-gray-700 font-medium mb-2">Corrección / Edición <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Ortotipográfica y de estilo. Coste estimado: 1-3€/página.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="editingCost" min="0" value="300" step="10" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label for="layoutCost" class="block text-gray-700 font-medium mb-2">Maquetación <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Diseño interior del libro. Coste estimado: 0.7-4€/página.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="layoutCost" min="0" value="250" step="10" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                         <div>
                            <label for="coverDesignCost" class="block text-gray-700 font-medium mb-2">Diseño de portada <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Diseño profesional. Coste estimado: 150-500€.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="coverDesignCost" min="0" value="375" step="10" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label for="illustrationsCost" class="block text-gray-700 font-medium mb-2">Ilustraciones / Gráficos <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Importante para infantil, opcional otros. Coste: 20-150€/ilustración.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="illustrationsCost" min="0" value="0" step="10" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-barcode mr-2 text-accent"></i> Legal y Administrativo
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="isbnCost" class="block text-gray-700 font-medium mb-2">ISBN <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Gratis en KDP (asignado por Amazon) o de pago si lo compras tú (45€ en España). Necesario para venta fuera de Amazon.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="isbnCost" min="0" value="0" step="1" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label for="legalDepositCost" class="block text-gray-700 font-medium mb-2">Depósito Legal <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Obligatorio en España si imprimes con imprenta y usas ISBN español. Gratuito (solo coste envío copias). No aplica a KDP normalmente.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="legalDepositCost" min="0" value="0" step="1" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-print mr-2 text-accent"></i> Impresión y Distribución
                    </h3>
                     <!-- KDP Specific Costs -->
                    <div id="kdpCostsSection">
                        <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-1 flex items-center"><i class="fab fa-amazon mr-2"></i> Amazon KDP (Impresión Bajo Demanda)</h4>
                            <p class="text-sm text-blue-700">No hay coste inicial de tirada. El coste de impresión se deduce de las regalías por cada venta. Introduce abajo el coste estimado que te da KDP.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label for="kdpPrintCost" class="block text-gray-700 font-medium mb-2">Coste impresión KDP por unidad <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Encuéntralo en la calculadora de KDP al configurar tu libro. Varía por mercado (.es, .com).</span></span></label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="kdpPrintCost" min="0" step="0.01" value="3.50" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                             <div>
                                <label for="kdpAuthorCopiesCost" class="block text-gray-700 font-medium mb-2">Coste total copias autor <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Coste de pedir copias para ti (impresión + envío). Inclúyelo si planeas pedir varias.</span></span></label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="kdpAuthorCopiesCost" min="0" step="1" value="50" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                        </div>
                    </div>
                     <!-- Traditional Print Specific Costs -->
                    <div id="traditionalPrintCostsSection" class="hidden">
                         <div class="bg-purple-50 p-4 rounded-lg mb-4 border border-purple-200">
                            <h4 class="font-semibold text-purple-800 mb-1 flex items-center"><i class="fas fa-print mr-2"></i> Imprenta Tradicional (Tirada)</h4>
                            <p class="text-sm text-purple-700">Requiere inversión inicial para imprimir un número determinado de copias (tirada).</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                            <div>
                                <label for="printRun" class="block text-gray-700 font-medium mb-2">Tirada inicial (copias)</label>
                                <input type="number" id="printRun" min="50" value="200" step="50" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label for="unitPrintCost" class="block text-gray-700 font-medium mb-2">Coste impresión por unidad</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="unitPrintCost" min="0" step="0.01" value="4.50" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                             <div>
                                <label for="totalPrintCost" class="block text-gray-700 font-medium mb-2">Coste total impresión</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="totalPrintCost" min="0" step="0.01" value="900" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-100" readonly>
                                </div>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="storageCost" class="block text-gray-700 font-medium mb-2">Almacenamiento / Distrib. <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Coste anual o mensual si usas un distribuidor o alquilas espacio. Pon 0 si lo almacenas tú.</span></span></label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="storageCost" min="0" value="50" step="10" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                             <div>
                                <label for="shippingCost" class="block text-gray-700 font-medium mb-2">Coste envío estimado (total) <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Coste total estimado para enviar libros a distribuidores, librerías o clientes directos durante el periodo.</span></span></label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="shippingCost" min="0" step="5" value="100" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-bullhorn mr-2 text-accent"></i> Marketing y Promoción
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="marketingCost" class="block text-gray-700 font-medium mb-2">Publicidad y Marketing <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Amazon Ads, Facebook Ads, material promocional, etc. Coste total estimado.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="marketingCost" min="0" value="200" step="10" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label for="eventsCost" class="block text-gray-700 font-medium mb-2">Eventos y Presentaciones <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Costes asociados a lanzamientos, firmas, ferias, etc.</span></span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="eventsCost" min="0" value="150" step="10" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="flex justify-between">
                    <button onclick="navigateToTab('basic')" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <button onclick="navigateToTab('pricing')" class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center">
                        Siguiente <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Pricing Tab -->
            <div id="pricing" class="tab-content p-6">
                 <h2 class="text-2xl font-bold text-dark mb-6">Precio y Proyección de Ventas</h2>
                 <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-tag mr-2 text-accent"></i> Precio y Regalías
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                         <div>
                            <label for="retailPrice" class="block text-gray-700 font-medium mb-2">Precio de venta al público (PVP)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="retailPrice" min="0" step="0.01" value="15.99" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Precio final en tienda (ej. Amazon.es)</p>
                        </div>
                         <div>
                             <label for="ebookPrice" class="block text-gray-700 font-medium mb-2">Precio Ebook (Opcional)</label>
                             <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                <input type="number" id="ebookPrice" min="0" step="0.01" value="4.99" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                             </div>
                             <p class="text-xs text-gray-500 mt-1">Introduce 0 si no hay ebook.</p>
                         </div>
                    </div>
                     <!-- KDP Royalties -->
                    <div id="kdpRoyaltySection">
                        <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-1 flex items-center"><i class="fab fa-amazon mr-2"></i> Regalías Amazon KDP</h4>
                            <p class="text-sm text-blue-700">Regalía Papel: 60% del PVP menos coste de impresión. Regalía Ebook: 70% (si precio 2.99-9.99€) o 35%.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label for="kdpPaperRoyaltyRate" class="block text-gray-700 font-medium mb-2">Regalía Papel KDP</label>
                                <div class="relative">
                                    <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">%</span>
                                    <input type="number" id="kdpPaperRoyaltyRate" value="60" class="w-full pr-10 pl-4 py-2 border rounded-lg bg-gray-100" readonly>
                                </div>
                            </div>
                             <div>
                                <label for="kdpAuthorEarningsPaper" class="block text-gray-700 font-medium mb-2">Ganancia por libro Papel (KDP)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="kdpAuthorEarningsPaper" min="0" step="0.01" class="w-full pl-8 pr-4 py-2 border rounded-lg bg-gray-100" readonly>
                                </div>
                            </div>
                            <div>
                               <label for="kdpEbookRoyaltyRate" class="block text-gray-700 font-medium mb-2">Regalía Ebook KDP</label>
                               <select id="kdpEbookRoyaltyRate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                   <option value="70">70% (Precio entre 2.99 y 9.99)</option>
                                   <option value="35">35% (Otros precios)</option>
                               </select>
                           </div>
                            <div>
                               <label for="kdpAuthorEarningsEbook" class="block text-gray-700 font-medium mb-2">Ganancia por Ebook (KDP)</label>
                               <div class="relative">
                                   <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                   <input type="number" id="kdpAuthorEarningsEbook" min="0" step="0.01" class="w-full pl-8 pr-4 py-2 border rounded-lg bg-gray-100" readonly>
                               </div>
                           </div>
                        </div>
                    </div>
                     <!-- Traditional Royalties/Earnings -->
                    <div id="traditionalRoyaltySection" class="hidden">
                         <div class="bg-purple-50 p-4 rounded-lg mb-4 border border-purple-200">
                            <h4 class="font-semibold text-purple-800 mb-1 flex items-center"><i class="fas fa-store mr-2"></i> Ganancias Imprenta Tradicional</h4>
                            <p class="text-sm text-purple-700">Tus ganancias dependen del canal de venta: directo (mayor margen) o a través de distribuidores/librerías (menor margen).</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="distributorCut" class="block text-gray-700 font-medium mb-2">% Distribuidor/Librería <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Porcentaje del PVP que se queda el canal de venta (30-60% habitual).</span></span></label>
                                <div class="relative">
                                    <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">%</span>
                                    <input type="number" id="distributorCut" min="0" max="100" value="50" step="1" class="w-full pr-10 pl-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                             <div>
                                <label for="traditionalAuthorEarningsStore" class="block text-gray-700 font-medium mb-2">Ganancia Venta Tienda</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                    <input type="number" id="traditionalAuthorEarningsStore" min="0" step="0.01" class="w-full pl-8 pr-4 py-2 border rounded-lg bg-gray-100" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">(PVP - % Distrib. - Coste Impresión)</p>
                            </div>
                            <div>
                               <label for="traditionalAuthorEarningsDirect" class="block text-gray-700 font-medium mb-2">Ganancia Venta Directa</label>
                               <div class="relative">
                                   <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">€</span>
                                   <input type="number" id="traditionalAuthorEarningsDirect" min="0" step="0.01" class="w-full pl-8 pr-4 py-2 border rounded-lg bg-gray-100" readonly>
                               </div>
                               <p class="text-xs text-gray-500 mt-1">(PVP - Coste Impresión)</p>
                           </div>
                        </div>
                    </div>
                </div>
                 <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-accent"></i> Proyección de Ventas
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label for="firstYearSalesPaper" class="block text-gray-700 font-medium mb-2">Ventas Papel 1er Año</label>
                            <input type="number" id="firstYearSalesPaper" min="0" value="300" step="10" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label for="subsequentSalesPaper" class="block text-gray-700 font-medium mb-2">Ventas Papel Años Sig.</label>
                            <input type="number" id="subsequentSalesPaper" min="0" value="100" step="10" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                         <div>
                            <label for="firstYearSalesEbook" class="block text-gray-700 font-medium mb-2">Ventas Ebook 1er Año</label>
                            <input type="number" id="firstYearSalesEbook" min="0" value="150" step="10" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                         <div>
                            <label for="subsequentSalesEbook" class="block text-gray-700 font-medium mb-2">Ventas Ebook Años Sig.</label>
                            <input type="number" id="subsequentSalesEbook" min="0" value="50" step="10" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div id="directSalesSection" class="hidden">
                            <label for="directSalesPercent" class="block text-gray-700 font-medium mb-2">% Ventas Papel Directas (Autor) <span class="tooltip"><i class="fas fa-info-circle text-xs text-gray-400"></i><span class="tooltip-text">Para imprenta: Qué porcentaje de ventas en papel harás tú directamente (web, eventos...).</span></span></label>
                            <div class="relative">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">%</span>
                                <input type="number" id="directSalesPercent" min="0" max="100" value="30" step="5" class="w-full pr-10 pl-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                         <div>
                            <label for="yearsProjection" class="block text-gray-700 font-medium mb-2">Años de proyección</label>
                            <input type="number" id="yearsProjection" min="1" max="10" value="3" step="1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                </div>
                 <div class="flex justify-between">
                    <button onclick="navigateToTab('costs')" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <button onclick="navigateToTab('compare')" class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center">
                        Siguiente <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Compare Tab -->
            <div id="compare" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-dark mb-6">Comparativa: KDP vs Imprenta Tradicional</h2>
                 <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2">
                         <!-- KDP Column -->
                        <div class="p-6 border-b md:border-b-0 md:border-r border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold text-blue-700 flex items-center">
                                    <i class="fab fa-amazon mr-2"></i> Amazon KDP
                                </h3>
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">Impresión Bajo Demanda</span>
                            </div>
                             <div class="space-y-3">
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Baja inversión inicial</h4><p class="text-xs text-gray-600">Sin coste de impresión por adelantado.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Distribución Global Fácil</h4><p class="text-xs text-gray-600">Acceso a tiendas Amazon mundiales.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Sin gestión de stock</h4><p class="text-xs text-gray-600">Impresión solo cuando se vende.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Facilidad de uso</h4><p class="text-xs text-gray-600">Plataforma integrada para publicar.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-times-circle text-red-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Menor control de calidad final</h4><p class="text-xs text-gray-600">No ves cada copia impresa.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-times-circle text-red-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Menor margen por libro (generalmente)</h4><p class="text-xs text-gray-600">El coste de impresión unitario suele ser mayor.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-times-circle text-red-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Dependencia de Amazon</h4><p class="text-xs text-gray-600">Difícil venta en librerías físicas.</p></div></div>
                            </div>
                        </div>
                         <!-- Traditional Column -->
                        <div class="p-6">
                             <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold text-purple-700 flex items-center">
                                    <i class="fas fa-print mr-2"></i> Imprenta Tradicional
                                </h3>
                                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-medium">Tirada Inicial</span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Mayor control de calidad</h4><p class="text-xs text-gray-600">Puedes revisar pruebas (ferros).</p></div></div>
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Potencial mayor margen por libro</h4><p class="text-xs text-gray-600">Coste unitario menor en tiradas grandes.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Flexibilidad de distribución</h4><p class="text-xs text-gray-600">Puedes vender donde quieras.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Variedad de acabados</h4><p class="text-xs text-gray-600">Más opciones de papeles, tintas, etc.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-times-circle text-red-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Alta inversión inicial</h4><p class="text-xs text-gray-600">Debes pagar la tirada completa.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-times-circle text-red-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Gestión de stock y logística</h4><p class="text-xs text-gray-600">Almacenamiento y envíos a tu cargo.</p></div></div>
                                <div class="flex items-start"><i class="fas fa-times-circle text-red-500 mt-1 mr-2 flex-shrink-0"></i><div><h4 class="font-medium text-gray-800 text-sm">Riesgo de inventario no vendido</h4><p class="text-xs text-gray-600">Puedes quedarte con libros sin vender.</p></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bg-gray-50 p-6 rounded-lg mb-8 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">¿Cuál elegir?</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-blue-200">
                            <h4 class="font-medium text-blue-700 mb-2 flex items-center"><i class="fab fa-amazon mr-2"></i> KDP puede ser mejor si...</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700">
                                <li>Priorizas la baja inversión inicial.</li>
                                <li>Es tu primer libro y quieres probar el mercado.</li>
                                <li>Tu público principal compra online (Amazon).</li>
                                <li>No quieres gestionar stock ni envíos complejos.</li>
                                <li>Buscas simplicidad y alcance global rápido.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200">
                            <h4 class="font-medium text-purple-700 mb-2 flex items-center"><i class="fas fa-print mr-2"></i> Imprenta puede ser mejor si...</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700">
                                <li>Buscas la máxima calidad y control sobre el producto final.</li>
                                <li>Quieres vender activamente en librerías físicas y eventos.</li>
                                <li>Tienes capital para la inversión inicial.</li>
                                <li>Tienes un plan claro de distribución y almacenamiento.</li>
                                <li>Preveés ventas suficientes para que el menor coste unitario compense.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                 <div class="flex justify-between">
                    <button onclick="navigateToTab('pricing')" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <button onclick="navigateToTab('results')" class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center">
                        Ver Resultados <i class="fas fa-chart-bar ml-2"></i>
                    </button>
                </div>
            </div>

             <!-- Results Tab -->
            <div id="results" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-dark mb-6">Resultados y Planificación Financiera (<span id="resultsPublishingFormat">KDP</span>)</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Initial Investment Card -->
                    <div class="result-card bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-semibold text-gray-800">Inversión Inicial</h3>
                            <span class="bg-red-100 text-red-800 px-2 py-0.5 rounded-full text-xs font-medium"><i class="fas fa-wallet mr-1"></i> Coste Fijo</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 mb-1" id="initialInvestmentDisplay">€0.00</div>
                        <p class="text-xs text-gray-500 mb-3">Costes antes de vender la 1ª copia.</p>
                        <div class="pt-3 border-t border-gray-100">
                            <h4 class="text-xs font-medium text-gray-600 mb-1">Desglose:</h4>
                            <ul class="text-xs space-y-0.5 text-gray-500">
                                <li class="flex justify-between"><span>Serv. Editoriales:</span> <span id="editorialCostsBreakdown">€0.00</span></li>
                                <li class="flex justify-between"><span>Diseño/Ilustración:</span> <span id="designCostsBreakdown">€0.00</span></li>
                                <li class="flex justify-between"><span>Legal/Admin:</span> <span id="legalCostsBreakdown">€0.00</span></li>
                                <li class="flex justify-between"><span>Marketing/Eventos:</span> <span id="marketingCostsBreakdown">€0.00</span></li>
                                <li class="flex justify-between"><span>Impresión/Otros:</span> <span id="printCostsBreakdown">€0.00</span></li>
                            </ul>
                        </div>
                    </div>
                     <!-- Break Even Card -->
                    <div class="result-card bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-semibold text-gray-800">Punto de Equilibrio</h3>
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full text-xs font-medium"><i class="fas fa-balance-scale mr-1"></i> Rentabilidad</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 mb-1" id="breakEvenDisplay">0 libros</div>
                        <p class="text-xs text-gray-500 mb-3">Copias a vender para cubrir inversión.</p>
                         <div class="pt-3 border-t border-gray-100">
                            <h4 class="text-xs font-medium text-gray-600 mb-1">Detalles:</h4>
                            <ul class="text-xs space-y-0.5 text-gray-500">
                                <li class="flex justify-between"><span>Ganancia media/libro:</span> <span id="avgEarningsPerBook">€0.00</span></li>
                                <li class="flex justify-between"><span>Ventas 1er año (total):</span> <span id="firstYearTotalSalesDisplay">0</span></li>
                                <li class="flex justify-between"><span>Tiempo estimado:</span> <span id="timeToBreakEven">N/A</span></li>
                             </ul>
                        </div>
                    </div>
                    <!-- Projection Card -->
                    <div class="result-card bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-semibold text-gray-800">Proyección <span id="projectionYearsDisplay">3</span> años</h3>
                            <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium"><i class="fas fa-chart-line mr-1"></i> Beneficio Neto</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 mb-1" id="totalNetProfitDisplay">€0.00</div>
                        <p class="text-xs text-gray-500 mb-3">Beneficio acumulado tras costes.</p>
                         <div class="pt-3 border-t border-gray-100">
                             <h4 class="text-xs font-medium text-gray-600 mb-1">Beneficio Neto Anual:</h4>
                             <ul class="text-xs space-y-0.5 text-gray-500" id="yearlyNetProfitList">
                                <!-- Populated by JS -->
                             </ul>
                        </div>
                    </div>
                </div>
                <!-- Charts Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 text-center">Distribución Inversión Inicial</h3>
                        <div class="h-56 sm:h-64 flex items-center justify-center">
                            <canvas id="costsChart"></canvas>
                        </div>
                    </div>
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 text-center">Proyección Beneficio Neto Acumulado</h3>
                        <div class="h-56 sm:h-64 flex items-center justify-center">
                            <canvas id="earningsChart"></canvas>
                        </div>
                    </div>
                </div>
                 <!-- Detailed Comparison Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8">
                    <div class="p-4 sm:p-6 border-b border-gray-200">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Tabla Comparativa Detallada</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Amazon KDP</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Imprenta</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                <tr>
                                    <td class="px-4 py-3 font-medium text-gray-900">Inversión inicial</td>
                                    <td class="px-4 py-3 text-gray-600" id="compKdpInitialInvestment">€0.00</td>
                                    <td class="px-4 py-3 text-gray-600" id="compTraditionalInitialInvestment">€0.00</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium text-gray-900">Coste impresión / unidad</td>
                                    <td class="px-4 py-3 text-gray-600" id="compKdpUnitCost">€0.00</td>
                                    <td class="px-4 py-3 text-gray-600" id="compTraditionalUnitCost">€0.00</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium text-gray-900">Ganancia media / libro papel</td>
                                    <td class="px-4 py-3 text-gray-600" id="compKdpEarningsPaper">€0.00</td>
                                    <td class="px-4 py-3 text-gray-600" id="compTraditionalEarningsPaperAvg">€0.00</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium text-gray-900">Ganancia media / ebook</td>
                                    <td class="px-4 py-3 text-gray-600" id="compKdpEarningsEbook">€0.00</td>
                                    <td class="px-4 py-3 text-gray-600">N/A</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium text-gray-900">Punto de equilibrio (libros)</td>
                                    <td class="px-4 py-3 text-gray-600" id="compKdpBreakEven">0</td>
                                    <td class="px-4 py-3 text-gray-600" id="compTraditionalBreakEven">0</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium text-gray-900">Beneficio neto 1er año</td>
                                    <td class="px-4 py-3 text-gray-600" id="compKdpYear1NetProfit">€0.00</td>
                                    <td class="px-4 py-3 text-gray-600" id="compTraditionalYear1NetProfit">€0.00</td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="px-4 py-3 font-semibold text-gray-900">Beneficio neto total (<span id="compProjectionYears">3</span> años)</td>
                                    <td class="px-4 py-3 font-semibold text-blue-700" id="compKdpTotalNetProfit">€0.00</td>
                                    <td class="px-4 py-3 font-semibold text-purple-700" id="compTraditionalTotalNetProfit">€0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <!-- Recommendations -->
                <div class="bg-gray-50 p-6 rounded-lg mb-8 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Recomendaciones Personalizadas (Ejemplos)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-medium text-secondary mb-2 flex items-center"><i class="fas fa-piggy-bank mr-2"></i> Optimizar Rentabilidad</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700" id="profitRecommendations">
                                <li>Considera ajustar el PVP para mejorar el margen por copia.</li>
                                <li>Si usas imprenta, pide presupuestos para tiradas mayores y compara el coste unitario.</li>
                                <li>Explora opciones de servicios editoriales más económicas si el presupuesto es ajustado.</li>
                            </ul>
                        </div>
                         <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-medium text-accent mb-2 flex items-center"><i class="fas fa-rocket mr-2"></i> Impulsar Ventas</h4>
                             <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700" id="salesRecommendations">
                                <li>Define tu público y enfoca el marketing (Amazon Ads, redes sociales).</li>
                                <li>Si usas imprenta, planifica activamente la distribución y ventas directas.</li>
                                <li>Ofrecer un ebook puede ampliar tu alcance y generar ingresos adicionales.</li>
                                <li>Recopila reseñas en Amazon; son cruciales para la visibilidad.</li>
                             </ul>
                        </div>
                    </div>
                </div>
                 <div class="flex justify-between items-center flex-wrap gap-4">
                    <button onclick="navigateToTab('compare')" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition flex items-center order-2 sm:order-1">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <span class="text-xs text-gray-500 order-1 sm:order-2">Estos cálculos son estimaciones. Consulta precios finales con proveedores.</span>
                    <button onclick="window.print()" class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center order-3">
                        <i class="fas fa-print mr-2"></i> Imprimir Informe
                    </button>
                </div>
            </div>
        </div>
    </main>

     <footer class="bg-dark text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0 text-center md:text-left">
                    <h2 class="text-xl font-bold mb-2">Calculadora de Autopublicación</h2>
                    <p class="text-gray-400 text-sm">Herramienta de planificación para autores.</p>
                </div>
                 <div class="text-center text-gray-500 text-xs">
                    <p>Los cálculos son estimaciones basadas en los datos introducidos.</p>
                    <p>© 2024 Calculadora Autopublicación. Adaptado y mejorado.</p>
                </div>
             </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Chart instances
        let costsChartInstance = null;
        let earningsChartInstance = null;

        // Helper Functions
        const getElementValue = (id, type = 'float') => {
            const element = document.getElementById(id);
            if (!element) return 0;
            const value = element.value;
            return type === 'int' ? parseInt(value) || 0 : parseFloat(value) || 0;
        };

        const setElementValue = (id, value, format = true) => {
            const element = document.getElementById(id);
            if (element) {
                element.value = format ? value.toFixed(2) : value;
            }
        };

        const setElementText = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        };

        const formatCurrency = (value) => {
            return value.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
        };

        // Tab Navigation
        function navigateToTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId)?.classList.add('active');
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`)?.classList.add('active');

            if (tabId === 'results') {
                calculateAndDisplayResults();
            }
            window.scrollTo(0, 0);
        }

        // Event listeners for tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                navigateToTab(this.getAttribute('data-tab'));
            });
        });

        // Toggle KDP/Traditional sections and update dependent fields
        document.querySelectorAll('input[name="publishingFormat"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isKdp = this.value === 'kdp';
                document.getElementById('kdpCostsSection').style.display = isKdp ? 'block' : 'none';
                document.getElementById('traditionalPrintCostsSection').style.display = isKdp ? 'none' : 'block';
                document.getElementById('kdpRoyaltySection').style.display = isKdp ? 'block' : 'none';
                document.getElementById('traditionalRoyaltySection').style.display = isKdp ? 'none' : 'block';
                document.getElementById('directSalesSection').style.display = isKdp ? 'none' : 'block';

                // Update results tab title
                setElementText('resultsPublishingFormat', isKdp ? 'KDP' : 'Imprenta');

                // Recalculate dynamic fields and potentially results if on results tab
                calculateDynamicUpdates();
                if (document.getElementById('results').classList.contains('active')) {
                    calculateAndDisplayResults();
                }
            });
        });

        // Update traditional print total cost automatically
        const printRunInput = document.getElementById('printRun');
        const unitPrintCostInput = document.getElementById('unitPrintCost');
        printRunInput.addEventListener('input', updateTraditionalTotalPrintCost);
        unitPrintCostInput.addEventListener('input', updateTraditionalTotalPrintCost);

        function updateTraditionalTotalPrintCost() {
            const printRun = getElementValue('printRun', 'int');
            const unitCost = getElementValue('unitPrintCost');
            setElementValue('totalPrintCost', printRun * unitCost);
            // If results are visible, update them
             if (document.getElementById('results').classList.contains('active')) {
                calculateAndDisplayResults();
            }
        }

        // --- Dynamic Calculations ---
        function calculateDynamicUpdates() {
            calculateKdpEarnings();
            calculateTraditionalEarnings();
            updateTraditionalTotalPrintCost(); // Ensure this is up-to-date
        }

        function calculateKdpEarnings() {
            const retailPrice = getElementValue('retailPrice');
            const kdpPrintCost = getElementValue('kdpPrintCost');
            const paperRoyaltyRate = getElementValue('kdpPaperRoyaltyRate') / 100; // Should be 0.60
            const ebookPrice = getElementValue('ebookPrice');
            const ebookRoyaltyRate = getElementValue('kdpEbookRoyaltyRate') / 100; // 0.70 or 0.35

            const kdpEarningsPaper = Math.max(0, (retailPrice * paperRoyaltyRate) - kdpPrintCost);
            setElementValue('kdpAuthorEarningsPaper', kdpEarningsPaper);

            // Basic delivery cost estimation for ebook royalty (can be refined)
            // Example: 0.15 EUR per MB, assume 2MB average size = 0.30 EUR
            const ebookDeliveryCost = ebookPrice > 0 ? (ebookRoyaltyRate === 0.70 ? 0.15 : 0) : 0; // Simplified - KDP has complex rules
            const kdpEarningsEbook = Math.max(0, (ebookPrice * ebookRoyaltyRate) - ebookDeliveryCost);
            setElementValue('kdpAuthorEarningsEbook', kdpEarningsEbook);
        }

        function calculateTraditionalEarnings() {
            const retailPrice = getElementValue('retailPrice');
            const unitPrintCost = getElementValue('unitPrintCost');
            const distributorCut = getElementValue('distributorCut') / 100; // e.g., 0.50

            // Earnings when sold through stores/distributors
            const storeEarnings = Math.max(0, retailPrice * (1 - distributorCut) - unitPrintCost);
            setElementValue('traditionalAuthorEarningsStore', storeEarnings);

            // Earnings when sold directly by the author
            const directEarnings = Math.max(0, retailPrice - unitPrintCost);
             setElementValue('traditionalAuthorEarningsDirect', directEarnings);
        }

        // Add listeners to recalculate earnings dynamically
        const fieldsAffectingEarnings = [
            'retailPrice', 'kdpPrintCost', 'ebookPrice', 'kdpEbookRoyaltyRate',
            'unitPrintCost', 'distributorCut'
        ];
        fieldsAffectingEarnings.forEach(id => {
            document.getElementById(id)?.addEventListener('input', () => {
                 calculateDynamicUpdates();
                 // If results are visible, update them
                 if (document.getElementById('results').classList.contains('active')) {
                    calculateAndDisplayResults();
                 }
            });
        });

         // Add listeners to all input/select fields to potentially trigger results update
         document.querySelectorAll('#basic input, #basic select, #costs input, #costs select, #pricing input, #pricing select').forEach(el => {
            el.addEventListener('input', () => {
                if (document.getElementById('results').classList.contains('active')) {
                    calculateAndDisplayResults();
                }
            });
             el.addEventListener('change', () => { // For selects primarily
                 if (document.getElementById('results').classList.contains('active')) {
                     calculateAndDisplayResults();
                 }
             });
         });

        // --- Main Calculation Function for Results Tab ---
        function calculateAndDisplayResults() {
            calculateDynamicUpdates(); // Ensure intermediate values are current

            const isKdp = document.getElementById('kdp').checked;
            const yearsProjection = getElementValue('yearsProjection', 'int');

            // --- Gather Costs ---
            const editingCost = getElementValue('editingCost');
            const layoutCost = getElementValue('layoutCost');
            const coverDesignCost = getElementValue('coverDesignCost');
            const illustrationsCost = getElementValue('illustrationsCost');
            const isbnCost = getElementValue('isbnCost');
            const legalDepositCost = getElementValue('legalDepositCost');
            const marketingCost = getElementValue('marketingCost');
            const eventsCost = getElementValue('eventsCost');

            const editorialCosts = editingCost + layoutCost;
            const designCosts = coverDesignCost + illustrationsCost;
            const legalCosts = isbnCost + legalDepositCost;
            const marketingEventsCosts = marketingCost + eventsCost;

            // KDP Specific Costs
            const kdpPrintCostPerUnit = getElementValue('kdpPrintCost');
            const kdpAuthorCopiesCost = getElementValue('kdpAuthorCopiesCost'); // This is an upfront cost if buying copies

            // Traditional Specific Costs
            const traditionalTotalPrintRunCost = getElementValue('totalPrintCost');
            const traditionalUnitPrintCost = getElementValue('unitPrintCost');
            const storageCost = getElementValue('storageCost'); // Assume this is a periodic cost, maybe factor per year later? For now, lump into initial.
            const shippingCost = getElementValue('shippingCost'); // Assume upfront estimate for distribution

            // --- Calculate Initial Investment ---
            const baseInvestment = editorialCosts + designCosts + legalCosts + marketingEventsCosts;
            let kdpInitialInvestment = baseInvestment + kdpAuthorCopiesCost; // KDP: Base + Author Copies
            let traditionalInitialInvestment = baseInvestment + traditionalTotalPrintRunCost + storageCost + shippingCost; // Trad: Base + Print Run + Storage + Shipping

            // --- Gather Sales Projections ---
            const firstYearSalesPaper = getElementValue('firstYearSalesPaper', 'int');
            const subsequentSalesPaper = getElementValue('subsequentSalesPaper', 'int');
            const firstYearSalesEbook = getElementValue('firstYearSalesEbook', 'int');
            const subsequentSalesEbook = getElementValue('subsequentSalesEbook', 'int');
            const directSalesPercent = getElementValue('directSalesPercent') / 100; // Only for traditional paper

            // --- Calculate Earnings Per Unit ---
            const kdpEarningsPaper = getElementValue('kdpAuthorEarningsPaper');
            const kdpEarningsEbook = getElementValue('kdpAuthorEarningsEbook');
            const traditionalEarningsStore = getElementValue('traditionalAuthorEarningsStore');
            const traditionalEarningsDirect = getElementValue('traditionalAuthorEarningsDirect');

            // Average traditional earnings per paper book based on direct/store split
            const traditionalEarningsPaperAvg = (traditionalEarningsDirect * directSalesPercent) + (traditionalEarningsStore * (1 - directSalesPercent));

            // --- Calculate Projections (for both models) ---
            let kdpProjection = calculateProjection(kdpInitialInvestment, kdpEarningsPaper, kdpEarningsEbook, firstYearSalesPaper, subsequentSalesPaper, firstYearSalesEbook, subsequentSalesEbook, yearsProjection);
            let traditionalProjection = calculateProjection(traditionalInitialInvestment, traditionalEarningsPaperAvg, 0, firstYearSalesPaper, subsequentSalesPaper, 0, 0, yearsProjection, directSalesPercent); // No ebook earnings assumed for traditional here

             // --- Determine which results to display based on user selection ---
            const selectedInvestment = isKdp ? kdpInitialInvestment : traditionalInitialInvestment;
            const selectedProjection = isKdp ? kdpProjection : traditionalProjection;
            const selectedAvgEarningsPerBook = isKdp
                ? ( (kdpEarningsPaper * (firstYearSalesPaper + subsequentSalesPaper * (yearsProjection -1))) + (kdpEarningsEbook * (firstYearSalesEbook + subsequentSalesEbook * (yearsProjection -1))) ) / Math.max(1, (firstYearSalesPaper + subsequentSalesPaper * (yearsProjection -1)) + (firstYearSalesEbook + subsequentSalesEbook * (yearsProjection -1)))
                : traditionalEarningsPaperAvg; // Simplified average for traditional (only paper)

            // --- Display Results ---
            // Cards
            setElementText('initialInvestmentDisplay', formatCurrency(selectedInvestment));
            setElementText('editorialCostsBreakdown', formatCurrency(editorialCosts));
            setElementText('designCostsBreakdown', formatCurrency(designCosts));
            setElementText('legalCostsBreakdown', formatCurrency(legalCosts));
            setElementText('marketingCostsBreakdown', formatCurrency(marketingEventsCosts));
            // Display the relevant 'other' cost based on selection
             const printDisplayCosts = isKdp ? kdpAuthorCopiesCost : (traditionalTotalPrintRunCost + storageCost + shippingCost);
            setElementText('printCostsBreakdown', formatCurrency(printDisplayCosts));


            setElementText('breakEvenDisplay', `${selectedProjection.breakEvenUnits.toLocaleString()} libros`);
             setElementText('avgEarningsPerBook', formatCurrency(selectedAvgEarningsPerBook || 0));
             setElementText('firstYearTotalSalesDisplay', isKdp ? (firstYearSalesPaper + firstYearSalesEbook).toLocaleString() : firstYearSalesPaper.toLocaleString());
            setElementText('timeToBreakEven', selectedProjection.breakEvenTime);

            setElementText('projectionYearsDisplay', yearsProjection);
            setElementText('totalNetProfitDisplay', formatCurrency(selectedProjection.totalNetProfit));
            const yearlyProfitList = document.getElementById('yearlyNetProfitList');
            yearlyProfitList.innerHTML = ''; // Clear previous
            selectedProjection.yearlyNetProfits.forEach((profit, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between';
                li.innerHTML = `<span>Año ${index + 1}:</span> <span>${formatCurrency(profit)}</span>`;
                yearlyProfitList.appendChild(li);
            });

            // Comparison Table
            setElementText('compKdpInitialInvestment', formatCurrency(kdpInitialInvestment));
            setElementText('compTraditionalInitialInvestment', formatCurrency(traditionalInitialInvestment));
            setElementText('compKdpUnitCost', formatCurrency(kdpPrintCostPerUnit));
            setElementText('compTraditionalUnitCost', formatCurrency(traditionalUnitPrintCost));
            setElementText('compKdpEarningsPaper', formatCurrency(kdpEarningsPaper));
            setElementText('compTraditionalEarningsPaperAvg', formatCurrency(traditionalEarningsPaperAvg));
            setElementText('compKdpEarningsEbook', formatCurrency(kdpEarningsEbook));
             setElementText('compKdpBreakEven', kdpProjection.breakEvenUnits.toLocaleString());
            setElementText('compTraditionalBreakEven', traditionalProjection.breakEvenUnits.toLocaleString());
            setElementText('compKdpYear1NetProfit', formatCurrency(kdpProjection.yearlyNetProfits[0] || 0));
            setElementText('compTraditionalYear1NetProfit', formatCurrency(traditionalProjection.yearlyNetProfits[0] || 0));
             setElementText('compProjectionYears', yearsProjection);
            setElementText('compKdpTotalNetProfit', formatCurrency(kdpProjection.totalNetProfit));
            setElementText('compTraditionalTotalNetProfit', formatCurrency(traditionalProjection.totalNetProfit));

            // --- Update Charts ---
             updateCostsChart(isKdp, editorialCosts, designCosts, legalCosts, marketingEventsCosts, printDisplayCosts);
             updateEarningsChart(selectedProjection.cumulativeNetProfits, yearsProjection, selectedInvestment);

             // --- Update Recommendations (Example) ---
             updateRecommendations(selectedProjection, selectedInvestment, getElementValue('retailPrice'));

        }

         function calculateProjection(initialInvestment, earningsPerPaper, earningsPerEbook, firstYearSalesPaper, subsequentSalesPaper, firstYearSalesEbook, subsequentSalesEbook, years, directSalesPercent = 0) {
             let cumulativeNetProfit = -initialInvestment;
             let totalGrossProfit = 0;
             let totalUnitsSold = 0;
             let yearlyNetProfits = [];
             let cumulativeNetProfits = [-initialInvestment]; // Start at year 0 with the investment

             const avgEarningsPerUnitCombined = // Calculate a weighted average for break-even
                 ((earningsPerPaper * (firstYearSalesPaper + subsequentSalesPaper * (years - 1))) +
                  (earningsPerEbook * (firstYearSalesEbook + subsequentSalesEbook * (years - 1)))) /
                 Math.max(1, (firstYearSalesPaper + subsequentSalesPaper * (years - 1)) + (firstYearSalesEbook + subsequentSalesEbook * (years - 1)));


             for (let year = 1; year <= years; year++) {
                 const salesPaper = (year === 1) ? firstYearSalesPaper : subsequentSalesPaper;
                 const salesEbook = (year === 1) ? firstYearSalesEbook : subsequentSalesEbook;

                 const grossProfitPaper = salesPaper * earningsPerPaper;
                 const grossProfitEbook = salesEbook * earningsPerEbook;
                 const yearlyGrossProfit = grossProfitPaper + grossProfitEbook;

                 totalGrossProfit += yearlyGrossProfit;
                 totalUnitsSold += salesPaper + salesEbook;

                 let yearlyNetProfit;
                 if (year === 1) {
                     yearlyNetProfit = yearlyGrossProfit - initialInvestment;
                 } else {
                     yearlyNetProfit = yearlyGrossProfit;
                 }
                 yearlyNetProfits.push(yearlyNetProfit);

                 cumulativeNetProfit += yearlyGrossProfit;
                 cumulativeNetProfits.push(cumulativeNetProfit);
             }

             // Break-even calculation (simplified: uses combined average earnings)
             const breakEvenUnits = (avgEarningsPerUnitCombined > 0) ? Math.ceil(initialInvestment / avgEarningsPerUnitCombined) : Infinity;
             let breakEvenTime = "Más de " + years + " años";
             if (breakEvenUnits !== Infinity) {
                 const firstYearTotalSales = firstYearSalesPaper + firstYearSalesEbook;
                 if (breakEvenUnits <= firstYearTotalSales && firstYearTotalSales > 0) {
                     const months = Math.ceil((breakEvenUnits / firstYearTotalSales) * 12);
                     breakEvenTime = `${months} meses`;
                 } else if (firstYearTotalSales > 0) {
                    let unitsRemaining = breakEvenUnits - firstYearTotalSales;
                    const subsequentYearlySales = subsequentSalesPaper + subsequentSalesEbook;
                    if (subsequentYearlySales > 0) {
                       const yearsNeeded = Math.ceil(unitsRemaining / subsequentYearlySales);
                       if (1 + yearsNeeded <= years) {
                            breakEvenTime = `~${1 + yearsNeeded} años`;
                       }
                    }
                 }
             }
              if (breakEvenUnits === 0 || initialInvestment === 0) breakEvenTime = "Inmediato";
              if (breakEvenUnits === Infinity) breakEvenTime = "Nunca";


             return {
                 totalNetProfit: cumulativeNetProfit,
                 breakEvenUnits: breakEvenUnits === Infinity ? 0 : breakEvenUnits, // Show 0 if infinite
                 breakEvenTime: breakEvenTime,
                 yearlyNetProfits: yearlyNetProfits,
                 cumulativeNetProfits: cumulativeNetProfits
             };
         }

        // --- Chart Functions ---
        function updateCostsChart(isKdp, editorial, design, legal, marketing, printOther) {
            const ctx = document.getElementById('costsChart').getContext('2d');
            const labels = ['Serv. Editoriales', 'Diseño/Ilust.', 'Legal/Admin', 'Marketing/Eventos', isKdp ? 'Copias Autor' : 'Impresión/Distrib.'];
            const data = [editorial, design, legal, marketing, printOther];
            const backgroundColors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', isKdp ? '#6366F1' : '#A855F7'];

            if (costsChartInstance) {
                costsChartInstance.data.labels = labels;
                costsChartInstance.data.datasets[0].data = data;
                costsChartInstance.data.datasets[0].backgroundColor = backgroundColors;
                costsChartInstance.update();
            } else {
                costsChartInstance = new Chart(ctx, {
                    type: 'doughnut', // or 'pie'
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Distribución de Costes Iniciales',
                            data: data,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { boxWidth: 12, font: { size: 10 } }
                            },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateEarningsChart(cumulativeData, years, initialInvestment) {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            const labels = Array.from({ length: years + 1 }, (_, i) => `Año ${i}`); // Year 0, Year 1, ...

            if (earningsChartInstance) {
                earningsChartInstance.data.labels = labels;
                earningsChartInstance.data.datasets[0].data = cumulativeData;
                 // Update the break-even line position
                if (earningsChartInstance.options.plugins.annotation) {
                   earningsChartInstance.options.plugins.annotation.annotations.line1.label.content = `Inversión: ${formatCurrency(initialInvestment)}`;
                }
                earningsChartInstance.update();
            } else {
                 earningsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Beneficio Neto Acumulado',
                            data: cumulativeData,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false, // Allow negative for initial investment
                                ticks: {
                                    callback: function(value, index, values) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                           legend: { display: false },
                           tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            },
                            // Potential Annotation plugin for break-even line (requires separate import)
                           // annotation: {
                           //     annotations: {
                           //         line1: {
                           //             type: 'line',
                           //             yMin: 0,
                           //             yMax: 0,
                           //             borderColor: 'rgb(255, 99, 132)',
                           //             borderWidth: 1,
                           //             borderDash: [5, 5],
                           //             label: {
                           //                 enabled: true,
                           //                 content: `Inversión: ${formatCurrency(initialInvestment)}`,
                           //                 position: 'end',
                           //                 yAdjust: -10,
                           //                 font: { size: 9 },
                           //                 backgroundColor: 'rgba(0,0,0,0.6)'
                           //             }
                           //         }
                           //     }
                           // }
                        }
                    }
                });
            }
        }

        // --- Recommendations Function (Example) ---
        function updateRecommendations(projection, investment, retailPrice) {
             const profitRecList = document.getElementById('profitRecommendations');
             profitRecList.innerHTML = ''; // Clear

             // Example Rec 1: Suggest increasing price if profit is low/negative
            if (projection.totalNetProfit < investment * 0.5 && projection.breakEvenUnits > 500) {
                const suggestedPrice = (retailPrice * 1.1).toFixed(2);
                 profitRecList.innerHTML += `<li>Considera subir el PVP (ej. a ${formatCurrency(parseFloat(suggestedPrice))}) para mejorar márgenes, si el mercado lo permite.</li>`;
             } else {
                  profitRecList.innerHTML += `<li>Tu margen actual parece razonable. Evalúa si los costes editoriales o de impresión se pueden optimizar.</li>`;
             }

             // Example Rec 2: Break-even time
             if (projection.breakEvenTime.includes("años") && parseInt(projection.breakEvenTime) > 2) {
                 profitRecList.innerHTML += `<li>El punto de equilibrio estimado es superior a 2 años. Revisa costes o estrategia de ventas.</li>`;
             } else if (projection.breakEvenTime === "Nunca") {
                 profitRecList.innerHTML += `<li class="text-red-600 font-medium">Con los datos actuales, no se recuperaría la inversión. Revisa PVP, costes y ventas.</li>`;
             }

             // Example Rec 3: Traditional print run cost
             if (!document.getElementById('kdp').checked && getElementValue('printRun', 'int') < 300 && getElementValue('unitPrintCost') > 5) {
                profitRecList.innerHTML += `<li>Para imprenta, tiradas bajas (< 300) suelen tener coste unitario alto. Compara presupuestos para 300-500 copias.</li>`;
             }

            // Add more recommendations based on your criteria
            profitRecList.innerHTML += `<li>Busca siempre varios presupuestos para servicios (edición, maquetación, impresión).</li>`;

            // Sales Recommendations (can also be dynamic)
             const salesRecList = document.getElementById('salesRecommendations');
             // Clear and add default or dynamic recommendations here if needed
        }

        // --- Reset Function ---
        function resetAll() {
            if (confirm('¿Estás seguro de que quieres reiniciar todos los datos a los valores por defecto?')) {
                // Reset basic info
                document.getElementById('novel').checked = true;
                document.getElementById('kdp').checked = true; // Default to KDP
                document.getElementById('pageCount').value = '150';
                document.getElementById('bookSize').value = '13.97x21.59';
                document.getElementById('printType').value = 'bw';
                document.getElementById('paperType').value = 'white';
                document.getElementById('bindingType').value = 'soft_matte';

                // Reset costs
                document.getElementById('editingCost').value = '300';
                document.getElementById('layoutCost').value = '250';
                document.getElementById('coverDesignCost').value = '375';
                document.getElementById('illustrationsCost').value = '0';
                document.getElementById('isbnCost').value = '0';
                document.getElementById('legalDepositCost').value = '0';
                document.getElementById('kdpPrintCost').value = '3.50';
                document.getElementById('kdpAuthorCopiesCost').value = '50';
                document.getElementById('printRun').value = '200';
                document.getElementById('unitPrintCost').value = '4.50';
                // totalPrintCost will update automatically
                document.getElementById('storageCost').value = '50';
                document.getElementById('shippingCost').value = '100';
                document.getElementById('marketingCost').value = '200';
                document.getElementById('eventsCost').value = '150';

                // Reset pricing & sales
                document.getElementById('retailPrice').value = '15.99';
                document.getElementById('ebookPrice').value = '4.99';
                document.getElementById('kdpEbookRoyaltyRate').value = '70';
                document.getElementById('distributorCut').value = '50';
                document.getElementById('firstYearSalesPaper').value = '300';
                document.getElementById('subsequentSalesPaper').value = '100';
                document.getElementById('firstYearSalesEbook').value = '150';
                document.getElementById('subsequentSalesEbook').value = '50';
                document.getElementById('directSalesPercent').value = '30';
                document.getElementById('yearsProjection').value = '3';

                 // Trigger UI update for sections visibility
                document.querySelector('input[name="publishingFormat"]:checked').dispatchEvent(new Event('change'));

                // Recalculate dynamic fields
                calculateDynamicUpdates();

                // Go to first tab and clear results if calculated
                navigateToTab('basic');
                 if(costsChartInstance) costsChartInstance.destroy(); costsChartInstance = null;
                 if(earningsChartInstance) earningsChartInstance.destroy(); earningsChartInstance = null;
                 // Clear results fields manually if needed or rely on next calculation
            }
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
             document.querySelector('input[name="publishingFormat"]:checked').dispatchEvent(new Event('change')); // Ensure correct sections are visible
             calculateDynamicUpdates(); // Calculate initial earnings etc.
             navigateToTab('basic'); // Start on the first tab
        });

    </script>
</body>
</html>